Reports:
  - ReportName: Device_Missing_CVEs_Summary_v2
    ReportPurpose: Summary analysis of missing CVE updates on endpoint devices with criticality tiers, impact scores, and asset counts. Focuses on CVEs older than 40 days to prioritize critical security patches.
    SecurityDomain: Endpoint
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
      - "AssetCount"
      - "TotalIssues"
      - "ImpactedAssets"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        // 1) Assets (endpoints only) + risk factors (customer facing / excluded)
        let Assets =
            ExposureGraphNodes
            | where tostring(NodeProperties.rawData.deviceCategory) == "Endpoint"
            // Risk factors from rawData/raw (booleans)
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            // Filter excluded assets
            | where EG_IsExcluded == false
            // Criticality
            | extend CriticalityLevel = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                tostring(NodeProperties.criticalityLevel.criticalityLevel)
            ))
            , CriticalityRuleBased = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
            ))
            , CriticalityRuleNames = coalesce(
                strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
            )
            , AadDeviceId = tostring(coalesce(
                NodeProperties.rawData.aadDeviceId,
                NodeProperties.raw.aadDeviceId,
                NodeProperties.aadDeviceId
            ))
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                AadDeviceId,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // 2) Findings
        let Findings =
            ExposureGraphNodes
            | mv-expand Category = Categories
            | where tostring(Category) contains "finding"
            | project
                FindingNodeId     = NodeId,
                FindingName       = NodeName,
                FindingLabel      = NodeLabel,
                FindingCategories = Categories,
                FindingProps      = NodeProperties;

        // 3) Edges
        let Edges =
            ExposureGraphEdges
            | where tostring(EdgeLabel) contains "affecting"
            | extend EdgeProps = column_ifexists("EdgeProperties", dynamic({}))
            | project SourceNodeId, TargetNodeId, EdgeLabel, EdgeProps;

        // 4) Asset ↔ Finding (both directions) -> dedupe per Asset+Finding
        let AF_edges_oneway =
            Edges
            | join kind=inner (Assets)   on $left.SourceNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.TargetNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel, AadDeviceId, EG_IsCustomerFacing, EG_IsExcluded,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames;

        let AF_edges_otherway =
            Edges
            | join kind=inner (Assets)   on $left.TargetNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.SourceNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel, AadDeviceId, EG_IsCustomerFacing, EG_IsExcluded,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames;

        let AF_edges = union AF_edges_oneway, AF_edges_otherway;

        AF_edges
        | summarize
            EdgeLabels           = make_set(EdgeLabel),
            EdgePropsAll         = make_bag(EdgeProps),
            FindingLabel         = any(FindingLabel),
            FindingCategories    = any(FindingCategories),
            FindingProps         = any(FindingProps),
            AssetProps           = any(AssetProps),
            CriticalityLevel     = any(CriticalityLevel),
            CriticalityRuleBased = any(CriticalityRuleBased),
            CriticalityRuleNames = any(CriticalityRuleNames),
            AadDeviceId          = any(AadDeviceId),
            EG_IsCustomerFacing  = any(EG_IsCustomerFacing),
            EG_IsExcluded        = any(EG_IsExcluded)
          by AssetName, AssetLabel, FindingName

        // Namespaced bag + pull Severity/CVSS/LastModified
        | extend Properties =
            bag_merge(
                bag_pack("finding", FindingProps),
                bag_pack("raw", iif(isnull(FindingProps.rawData), dynamic({}), FindingProps.rawData)),
                bag_pack("edge", EdgePropsAll)
            )

        | extend Impact = todouble(coalesce(
                Properties.raw.cvssScore,
                Properties.finding.raw.cvssScore,
                Properties.raw.cvss.cvssScore
            ))
        | extend SecuritySeverity = tostring(Properties.raw.severity)

        // CVEs only
        | where FindingLabel contains "CVE"

        // exploit-related flags (4 values) ----
        | extend HasExploit = tobool(coalesce(
            Properties.finding.rawData.hasExploit,
            Properties.raw.hasExploit,
            Properties.finding.raw.hasExploit
        ))
        | extend IsExploitVerified = tobool(coalesce(
            Properties.finding.rawData.isExploitVerified,
            Properties.raw.isExploitVerified,
            Properties.finding.raw.isExploitVerified
        ))
        | extend IsInExploitKit = tobool(coalesce(
            Properties.finding.rawData.isInExploitKit,
            Properties.raw.isInExploitKit,
            Properties.finding.raw.isInExploitKit
        ))
        | extend IsZeroDay = tobool(coalesce(
            Properties.finding.rawData.isZeroDay,
            Properties.raw.isZeroDay,
            Properties.finding.raw.isZeroDay
        ))

        // Risk factors at row level (0/1)
        | extend RiskFactor_Consequence =
            iff(HasExploit == true or IsExploitVerified == true or IsInExploitKit == true or IsZeroDay == true, 1, 0)
        | extend RiskFactor_Probability =
            iff(EG_IsCustomerFacing == true, 1, 0)

        // Criticality tiering
        | extend CriticalityTier = toint(coalesce(CriticalityLevel, 3))
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 0, "Critical - tier 0",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 3, "Low - tier 3",
                "Unknown - unmapped"
            )

        // Hardcode Category/Subcategory
        | extend SecurityDomain = "Endpoint"
        | extend ConfigurationName = "Update vulnerable software"
        | extend ConfigurationId = "CVE"
        | extend Category    = "Vulnerabilities"
        | extend Subcategory = "CVEs (Missing Updates)"

        // CVE last modified filter
        | extend CVELastModified = todatetime(coalesce(Properties.finding.raw.lastModifiedDate, Properties.raw.lastModifiedDate))
        | where CVELastModified < ago(40d)

        // Device key for counting
        | extend DeviceKey = iif(isnotempty(AadDeviceId), AadDeviceId, AssetName)

        // Summarize + include risk factors (as “any flag present in the group”)
        | summarize
            AssetCount      = dcount(DeviceKey),
            TotalIssues     = count(),
            AvgImpact       = avg(Impact),
            MaxImpact       = max(Impact),
            ImpactedAssets  = make_set(AssetName),
            SampleCVEs      = make_set(FindingLabel),
            RiskFactor_Consequence = max(RiskFactor_Consequence),
            RiskFactor_Probability = max(RiskFactor_Probability)
          by SecurityDomain, Category, Subcategory, ConfigurationName, ConfigurationId, CriticalityTier, CriticalityTierLevel, SecuritySeverity

        | project
            SecurityDomain,
            Category,
            Subcategory,
            ConfigurationName,
            ConfigurationId,
            CriticalityTier,
            CriticalityTierLevel,
            SecuritySeverity,
            RiskFactor_Consequence,
            RiskFactor_Probability,
            AssetCount,
            TotalIssues,
            AvgImpact = round(AvgImpact, 1),
            MaxImpact = toint(ceiling(MaxImpact)),
            ImpactedAssets,
            SampleCVEs
        | order by CriticalityTier asc, MaxImpact desc, AvgImpact desc, AssetCount desc, TotalIssues desc
                
  - ReportName: Device_Missing_CVEs_Detailed_v2
    ReportPurpose: Detailed analysis of missing CVE updates on individual endpoint devices with criticality tiers, CVSS impact scores, and comprehensive vulnerability details. Focuses on CVEs older than 40 days for detailed remediation planning.
    SecurityDomain: Endpoint
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
      - "AadDeviceId"
      - "CVELastModified"
      - "CVSSDesc"
      - "CVE_ID"
      - "CriticalityRuleBased"
      - "CriticalityRuleNames"
      - "CriticalityLevel"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        // 1) Assets (endpoints only) + risk factors (customer facing / excluded)
        let Assets =
            ExposureGraphNodes
            | where tostring(NodeProperties.rawData.deviceCategory) == "Endpoint"
            // Risk factors from rawData/raw (booleans)
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            // Filter excluded assets
            | where EG_IsExcluded == false
            // Criticality
            | extend CriticalityLevel = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                tostring(NodeProperties.criticalityLevel.criticalityLevel)
            ))
            , CriticalityRuleBased = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
            ))
            , CriticalityRuleNames = coalesce(
                strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
            )
            , AadDeviceId = tostring(coalesce(
                NodeProperties.rawData.aadDeviceId,
                NodeProperties.raw.aadDeviceId,
                NodeProperties.aadDeviceId
            ))
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                AadDeviceId,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // 2) Findings
        let Findings =
            ExposureGraphNodes
            | mv-expand Category = Categories
            | where tostring(Category) contains "finding"
            | project
                FindingNodeId     = NodeId,
                FindingName       = NodeName,
                FindingLabel      = NodeLabel,
                FindingCategories = Categories,
                FindingProps      = NodeProperties;

        // 3) Edges
        let Edges =
            ExposureGraphEdges
            | where tostring(EdgeLabel) contains "affecting"
            | extend EdgeProps = column_ifexists("EdgeProperties", dynamic({}))
            | project SourceNodeId, TargetNodeId, EdgeLabel, EdgeProps;

        // 4) Asset ↔ Finding (both directions) -> dedupe per Asset+Finding
        let AF_edges_oneway =
            Edges
            | join kind=inner (Assets)   on $left.SourceNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.TargetNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel, AadDeviceId, EG_IsCustomerFacing, EG_IsExcluded,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames;

        let AF_edges_otherway =
            Edges
            | join kind=inner (Assets)   on $left.TargetNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.SourceNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel, AadDeviceId, EG_IsCustomerFacing, EG_IsExcluded,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames;

        let AF_edges = union AF_edges_oneway, AF_edges_otherway;

        AF_edges
        | summarize
            EdgeLabels           = make_set(EdgeLabel),
            EdgePropsAll         = make_bag(EdgeProps),
            FindingLabel         = any(FindingLabel),
            FindingCategories    = any(FindingCategories),
            FindingProps         = any(FindingProps),
            AssetProps           = any(AssetProps),
            CriticalityLevel     = any(CriticalityLevel),
            CriticalityRuleBased = any(CriticalityRuleBased),
            CriticalityRuleNames = any(CriticalityRuleNames),
            AadDeviceId          = any(AadDeviceId),
            EG_IsCustomerFacing  = any(EG_IsCustomerFacing),
            EG_IsExcluded        = any(EG_IsExcluded)
          by AssetName, AssetLabel, FindingName

        // Namespaced bag
        | extend Properties =
            bag_merge(
                bag_pack("finding", FindingProps),
                bag_pack("raw", iif(isnull(FindingProps.rawData), dynamic({}), FindingProps.rawData)),
                bag_pack("edge", EdgePropsAll)
            )

        | extend Impact = todouble(coalesce(
                Properties.raw.cvssScore,
                Properties.finding.raw.cvssScore,
                Properties.raw.cvss.cvssScore
            ))
        | extend SecuritySeverity = tostring(Properties.raw.severity)

        // CVEs only
        | where FindingLabel contains "CVE"

        // Criticality tiers
        | extend CriticalityTier = toint(coalesce(CriticalityLevel, 3))
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 0, "Critical - tier 0",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 3, "Low - tier 3",
                "Unknown - unmapped"
            )

        // Hardcode domain/category/subcategory for this dataset
        | extend SecurityDomain = "Endpoint"
        | extend ConfigurationId = "CVE"
        | extend Category    = "Vulnerabilities"
        | extend Subcategory = "CVEs (Missing Updates)"

        // CVE last modified filter
        | extend CVELastModified = todatetime(coalesce(Properties.finding.raw.lastModifiedDate, Properties.raw.lastModifiedDate))
        | where CVELastModified < ago(40d)

        // exploit-related flags from finding rawData/raw ----
        | extend HasExploit = tobool(coalesce(
            Properties.finding.rawData.hasExploit,
            Properties.raw.hasExploit,
            Properties.finding.raw.hasExploit
        ))
        | extend IsExploitVerified = tobool(coalesce(
            Properties.finding.rawData.isExploitVerified,
            Properties.raw.isExploitVerified,
            Properties.finding.raw.isExploitVerified
        ))
        | extend IsInExploitKit = tobool(coalesce(
            Properties.finding.rawData.isInExploitKit,
            Properties.raw.isInExploitKit,
            Properties.finding.raw.isInExploitKit
        ))
        | extend IsZeroDay = tobool(coalesce(
            Properties.finding.rawData.isZeroDay,
            Properties.raw.isZeroDay,
            Properties.finding.raw.isZeroDay
        ))

        // Risk factors (0/1)
        | extend RiskFactor_Consequence =
            iff(HasExploit == true or IsExploitVerified == true or IsInExploitKit == true or IsZeroDay == true, 1, 0)
        | extend RiskFactor_Probability =
            iff(EG_IsCustomerFacing == true, 1, 0)

        // (extra safety) ensure excluded assets never leak through post-joins
        | where EG_IsExcluded == false

        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName,
            AssetLabel,
            AadDeviceId,
            EG_IsCustomerFacing,
            EG_IsExcluded,

            ConfigurationName = FindingName,
            CVE_ID = FindingLabel,
            ConfigurationId,

            CriticalityLevel,
            CriticalityRuleBased,
            CriticalityRuleNames,
            CriticalityTier,
            CriticalityTierLevel,

            Impact,
            SecuritySeverity,
            CVELastModified,

            HasExploit,
            IsExploitVerified,
            IsInExploitKit,
            IsZeroDay,

            RiskFactor_Consequence,
            RiskFactor_Probability,

            CVSSDesc = tostring(coalesce(
                Properties.finding.rawData.description,
                Properties.raw.description,
                Properties.finding.raw.description
            )),
            AssetProps,
            Properties
        | order by CriticalityTier asc, Impact desc, AssetName asc, CVE_ID asc

  - ReportName: Device_Missing_CVEs_Detailed_BucketFilter_v2
    ReportPurpose: Detailed analysis of missing CVE updates on individual endpoint devices with criticality tiers, CVSS impact scores, and comprehensive vulnerability details. Focuses on CVEs older than 40 days for detailed remediation planning.
    SecurityDomain: Endpoint
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
      - "AadDeviceId"
      - "CVELastModified"
      - "CVSSDesc"
      - "CVE_ID"
      - "CriticalityRuleBased"
      - "CriticalityRuleNames"
      - "CriticalityLevel"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        // 1) Assets (endpoints only) + risk factors (customer facing / excluded)
        let Assets =
            ExposureGraphNodes
            | where tostring(NodeProperties.rawData.deviceCategory) == "Endpoint"
            // Risk factors from rawData/raw (booleans)
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            // Filter excluded assets
            | where EG_IsExcluded == false
            // Criticality
            | extend CriticalityLevel = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                tostring(NodeProperties.criticalityLevel.criticalityLevel)
            ))
            , CriticalityRuleBased = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
            ))
            , CriticalityRuleNames = coalesce(
                strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
            )
            , AadDeviceId = tostring(coalesce(
                NodeProperties.rawData.aadDeviceId,
                NodeProperties.raw.aadDeviceId,
                NodeProperties.aadDeviceId
            ))
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                AadDeviceId,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // 2) Findings
        let Findings =
            ExposureGraphNodes
            | mv-expand Category = Categories
            | where tostring(Category) contains "finding"
            | project
                FindingNodeId     = NodeId,
                FindingName       = NodeName,
                FindingLabel      = NodeLabel,
                FindingCategories = Categories,
                FindingProps      = NodeProperties;

        // 3) Edges
        let Edges =
            ExposureGraphEdges
            | where tostring(EdgeLabel) contains "affecting"
            | extend EdgeProps = column_ifexists("EdgeProperties", dynamic({}))
            | project SourceNodeId, TargetNodeId, EdgeLabel, EdgeProps;

        // 4) Asset ↔ Finding (both directions) -> dedupe per Asset+Finding
        let AF_edges_oneway =
            Edges
            | join kind=inner (Assets)   on $left.SourceNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.TargetNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel, AadDeviceId, EG_IsCustomerFacing, EG_IsExcluded,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames;

        let AF_edges_otherway =
            Edges
            | join kind=inner (Assets)   on $left.TargetNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.SourceNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel, AadDeviceId, EG_IsCustomerFacing, EG_IsExcluded,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames;

        let AF_edges = union AF_edges_oneway, AF_edges_otherway;

        AF_edges
        | summarize
            EdgeLabels           = make_set(EdgeLabel),
            EdgePropsAll         = make_bag(EdgeProps),
            FindingLabel         = any(FindingLabel),
            FindingCategories    = any(FindingCategories),
            FindingProps         = any(FindingProps),
            AssetProps           = any(AssetProps),
            CriticalityLevel     = any(CriticalityLevel),
            CriticalityRuleBased = any(CriticalityRuleBased),
            CriticalityRuleNames = any(CriticalityRuleNames),
            AadDeviceId          = any(AadDeviceId),
            EG_IsCustomerFacing  = any(EG_IsCustomerFacing),
            EG_IsExcluded        = any(EG_IsExcluded)
          by AssetName, AssetLabel, FindingName

        // Namespaced bag
        | extend Properties =
            bag_merge(
                bag_pack("finding", FindingProps),
                bag_pack("raw", iif(isnull(FindingProps.rawData), dynamic({}), FindingProps.rawData)),
                bag_pack("edge", EdgePropsAll)
            )

        | extend Impact = todouble(coalesce(
                Properties.raw.cvssScore,
                Properties.finding.raw.cvssScore,
                Properties.raw.cvss.cvssScore
            ))
        | extend SecuritySeverity = tostring(Properties.raw.severity)

        // CVEs only
        | where FindingLabel contains "CVE"

        // Criticality tiers
        | extend CriticalityTier = toint(coalesce(CriticalityLevel, 3))
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 0, "Critical - tier 0",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 3, "Low - tier 3",
                "Unknown - unmapped"
            )

        // Hardcode domain/category/subcategory for this dataset
        | extend SecurityDomain = "Endpoint"
        | extend ConfigurationId = "CVE"
        | extend Category    = "Vulnerabilities"
        | extend Subcategory = "CVEs (Missing Updates)"

        // CVE last modified filter
        | extend CVELastModified = todatetime(coalesce(Properties.finding.raw.lastModifiedDate, Properties.raw.lastModifiedDate))
        | where CVELastModified < ago(40d)

        // exploit-related flags from finding rawData/raw ----
        | extend HasExploit = tobool(coalesce(
            Properties.finding.rawData.hasExploit,
            Properties.raw.hasExploit,
            Properties.finding.raw.hasExploit
        ))
        | extend IsExploitVerified = tobool(coalesce(
            Properties.finding.rawData.isExploitVerified,
            Properties.raw.isExploitVerified,
            Properties.finding.raw.isExploitVerified
        ))
        | extend IsInExploitKit = tobool(coalesce(
            Properties.finding.rawData.isInExploitKit,
            Properties.raw.isInExploitKit,
            Properties.finding.raw.isInExploitKit
        ))
        | extend IsZeroDay = tobool(coalesce(
            Properties.finding.rawData.isZeroDay,
            Properties.raw.isZeroDay,
            Properties.finding.raw.isZeroDay
        ))

        // Risk factors (0/1)
        | extend RiskFactor_Consequence =
            iff(HasExploit == true or IsExploitVerified == true or IsInExploitKit == true or IsZeroDay == true, 1, 0)
        | extend RiskFactor_Probability =
            iff(EG_IsCustomerFacing == true, 1, 0)

        // (extra safety) ensure excluded assets never leak through post-joins
        | where EG_IsExcluded == false

        // Bucket filter
        | extend DeviceKey = iif(isnotempty(AadDeviceId), AadDeviceId, AssetName)
        __BUCKET_FILTER__

        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName,
            AssetLabel,
            AadDeviceId,
            EG_IsCustomerFacing,
            EG_IsExcluded,

            ConfigurationName = FindingName,
            CVE_ID = FindingLabel,
            ConfigurationId,

            CriticalityLevel,
            CriticalityRuleBased,
            CriticalityRuleNames,
            CriticalityTier,
            CriticalityTierLevel,

            Impact,
            SecuritySeverity,
            CVELastModified,

            HasExploit,
            IsExploitVerified,
            IsInExploitKit,
            IsZeroDay,

            RiskFactor_Consequence,
            RiskFactor_Probability,

            CVSSDesc = tostring(coalesce(
                Properties.finding.rawData.description,
                Properties.raw.description,
                Properties.finding.raw.description
            )),
            AssetProps,
            Properties
        | order by CriticalityTier asc, Impact desc, AssetName asc, CVE_ID asc
        
  - ReportName: Device_Recommendations_Summary_v2
    ReportPurpose: Summary analysis of Microsoft Defender for Endpoint TVM secure configuration recommendations aggregated by criticality tiers, security severity, and configuration categories. Provides actionable insights for endpoint hardening.
    SecurityDomain: Endpoint
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
      - "AssetCount"
      - "TotalIssues"
      - "ImpactedAssets"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let excludeForWindowsServer = dynamic([
          "scid-2090",
          "scid-22"
        ]);

        // ===================== LOOKUP TABLES (short standard texts) =====================
        let CategoryLookup = datatable(Category:string, CategoryDescription:string)
        [
          "Security controls", "Endpoint protection and attack-surface policies that block common malware and attacker techniques.",
          "Network",           "Network security policies that limit attack surface and lateral movement.",
          "BitLocker",         "Full-disk encryption to prevent data exposure on lost or stolen devices.",
          "OS",                "Operating system baseline hardening and core protections.",
          "Credentials",       "Controls that prevent credential theft and reuse.",
          "Browser",           "Safe browsing and web threat protections.",
          "Application",       "Application control and exploit protection to restrict unauthorized code execution.",
          "Device",            "General endpoint configuration and health requirements.",
          "Audit",             "Monitoring-focused baselines to validate configuration posture."
        ];

        let SubCategoryLookup = datatable(Subcategory:string, SubCategoryDescription:string)
        [
          "EDR",                        "Defender for Endpoint sensor presence and reporting health.",
          "Attack Surface Reduction",   "Blocks common malware execution paths from email, web and Office content.",
          "Firewall",                   "Enforces inbound/outbound traffic policy and host firewall state.",
          "Antivirus",                  "Ensures Microsoft Defender Antivirus is active and properly configured.",
          "BitLocker",                  "Enforces full-disk encryption and key escrow.",
          "Exploit Guard",              "Hardens OS/apps against memory corruption and exploit chains.",
          "Authentication",             "Strengthens sign-in security and protects credential boundaries.",
          "Remote Access",              "Restricts remote shell/administrative entry points.",
          "TLS/Communication",          "Requires secure protocols and prevents crypto downgrade.",
          "Removable Storage",          "Controls external media to reduce malware risk and data exfiltration."
        ];

        // ===================== PARAMETERS =====================
        let lookback         = 30d;
        let onlyApplicable   = true;
        let osFilter         = dynamic([]);     // e.g. ["Windows10","Windows11","Linux","macOS"]
        let categoryFilter   = dynamic([]);     // e.g. ["Security controls","Network"]
        let idFilter         = dynamic([]);     // e.g. ["scid-2500","scid-10003"]
        let nameSearch       = "";
        let sortByImpactDesc = true;
        let SecurityDomain   = "Endpoint";

        // ===================== DEVICEINFO (latest) =====================
        let DeviceInfoLatest =
          DeviceInfo
          | where TimeGenerated >= ago(lookback)
          | summarize arg_max(TimeGenerated, *) by DeviceId
          | project
              DeviceId,
              DI_DeviceName      = DeviceName,
              DI_OSPlatform      = OSPlatform,
              DI_MachineGroup    = MachineGroup,
              DI_AssetValue      = tostring(AssetValue),
              DI_ExposureLevel   = tostring(ExposureLevel),
              DI_AzureResourceId = tostring(AzureResourceId),
              DI_AadDeviceId     = tostring(AadDeviceId);

        // ===================== EXPOSURE GRAPH (Endpoint assets, join via aadDeviceId) =====================
        let EG_Assets =
          ExposureGraphNodes
          | extend CriticalityLevel = toint(coalesce(
              tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
              tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
              tostring(NodeProperties.criticalityLevel.criticalityLevel)
            ))
          , CriticalityRuleBased = toint(coalesce(
              tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
              tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
              tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
            ))
          , CriticalityRuleNames = coalesce(
              strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
              strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
            )
          // EG uses aadDeviceId inside NodeProperties; support both rawData and raw
          | extend EG_AadDeviceId = tostring(coalesce(
              NodeProperties.rawData.aadDeviceId,
              NodeProperties.raw.aadDeviceId,
              NodeProperties.aadDeviceId
            ))
          // Risk factors from rawData/raw (booleans)
          | extend EG_IsCustomerFacing = tobool(coalesce(
              NodeProperties.rawData.isCustomerFacing,
              NodeProperties.raw.isCustomerFacing
            ))
          | extend EG_IsExcluded = tobool(coalesce(
              NodeProperties.rawData.isExcluded,
              NodeProperties.raw.isExcluded
            ))
          | project
              EG_AadDeviceId,
              EG_AssetName    = NodeName,
              EG_AssetLabel   = NodeLabel,
              EG_AssetProps   = NodeProperties,
              EG_CriticalityLevel = CriticalityLevel,
              EG_IsCustomerFacing,
              EG_IsExcluded;

        // ===================== TVM SECURE CONFIG (core) =====================
        let TVM_Base =
          DeviceTvmSecureConfigurationAssessment
          | where TimeGenerated >= ago(lookback)
          | where (array_length(osFilter) == 0 or OSPlatform in~ (osFilter))
          | where (array_length(idFilter) == 0 or ConfigurationId in~ (idFilter))
          | where (nameSearch == "" or tostring(DeviceName) contains nameSearch)
          // Exclude configuration IDs only for Windows Server devices
          | where not (OSPlatform contains "WindowsServer" and ConfigurationId in~ (excludeForWindowsServer))
          | where iff(onlyApplicable, IsApplicable == 1, true)
          | join kind=leftouter (
              DeviceTvmSecureConfigurationAssessmentKB
              | project
                  ConfigurationId,
                  KB_ConfigurationName        = ConfigurationName,
                  KB_ConfigurationCategory    = ConfigurationCategory,
                  KB_ConfigurationSubcategory = ConfigurationSubcategory,
                  KB_Impact                   = toint(ConfigurationImpact),
                  KB_RiskDescription          = tostring(RiskDescription),
                  KB_Description              = tostring(ConfigurationDescription),
                  KB_Remediation              = tostring(RemediationOptions),
                  KB_Benchmarks               = ConfigurationBenchmarks
            ) on ConfigurationId
          | where (array_length(categoryFilter) == 0 or KB_ConfigurationCategory in~ (categoryFilter))
          | extend ImpactInt = toint(coalesce(KB_Impact, toint(ConfigurationImpact)))
          | extend
              Category          = coalesce(KB_ConfigurationCategory, ConfigurationCategory),
              Subcategory       = KB_ConfigurationSubcategory,
              ConfigurationName = coalesce(KB_ConfigurationName, tostring(ConfigurationId)),
              IsCompliant       = tobool(IsCompliant),
              IsApplicable      = tobool(IsApplicable)
          | extend
              RecommendedAction =
                  case(
                      ImpactInt >= 9, "Fix immediately - Security Change Queue / Intune / GPO rollout",
                      ImpactInt == 8, "Schedule within quarterly hardening cycle",
                      ImpactInt >= 5 and ImpactInt < 8, "Fix opportunistically (during upgrades / refresh)",
                      "Monitor, document as baseline exceptions"
                  ),
              SecuritySeverity =
                  case(
                      ImpactInt == 10, "Very High",
                      ImpactInt == 9,  "High",
                      ImpactInt == 8,  "Medium-High",
                      ImpactInt >= 5,  "Medium",
                      "Low Risk"
                  ),
              SecuritySeverityDescription =
                  case(
                      ImpactInt == 10, "If this configuration is not applied, attackers gain a major foothold or common attack vector remains wide open.",
                      ImpactInt == 9,  "Strongly recommended to fix ASAP; commonly exploited by real-world malware and ransomware.",
                      ImpactInt == 8,  "Important baseline security hardening; reduces attack surface and lateral movement.",
                      ImpactInt >= 5,  "Security best practice; helps reduce exposure but less frequently exploited.",
                      "Hardening / hygiene controls; helps, but attackers less likely to target."
                  ),
              SortKey = iff(sortByImpactDesc, todouble(ImpactInt), 0.0)
          | summarize arg_max(TimeGenerated, *) by DeviceId, ConfigurationId
          | where IsCompliant == false
          | lookup CategoryLookup on Category
          | lookup SubCategoryLookup on Subcategory
          | extend
              CategoryDescription    = coalesce(CategoryDescription, "Category description not defined"),
              SubCategoryDescription = coalesce(SubCategoryDescription, "Subcategory description not defined");

        // ===================== ENRICH + SUMMARY =====================
        TVM_Base
        | join kind=leftouter (DeviceInfoLatest) on DeviceId
        | join kind=leftouter (
            EG_Assets
            | where isnotempty(EG_AadDeviceId)
        ) on $left.DI_AadDeviceId == $right.EG_AadDeviceId
        | extend Criticality = toint(EG_CriticalityLevel)
        | where isnotempty(Criticality)
        | where EG_IsExcluded == false
        // materialize SecurityDomain as a column (from the scalar)
        | extend SecurityDomain = SecurityDomain
        | extend CriticalityTier = toint(Criticality)
        | extend CriticalityTierLevel =
            case(
              CriticalityTier == 3, "Low - tier 3",
              CriticalityTier == 2, "Medium - tier 2",
              CriticalityTier == 1, "High - tier 1",
              CriticalityTier == 0, "Critical - tier 0",
              "Unknown - unmapped"
            )
        // risk factors (0/1) at row-level
        | extend
            RiskFactor_Probability = iff(EG_IsCustomerFacing == true, 1, 0),
            RiskFactor_Consequence = 0
        // --- Summarize by Subcategory ---
        | summarize
            AssetCount     = dcount(DeviceId),
            TotalIssues    = count(),
            ImpactedAssets = make_set(coalesce(DI_DeviceName, DeviceName)),
            RiskFactor_Probability = toint(max(RiskFactor_Probability)),
            RiskFactor_Consequence = toint(max(RiskFactor_Consequence))            
          by
            SecurityDomain,
            Category,
            Subcategory,
            CriticalityTier,
            CriticalityTierLevel,
            Impact = ImpactInt,
            SecuritySeverity,
            ConfigurationName,
            ConfigurationId
        | project
            SecurityDomain,
            Category,
            Subcategory,
            ConfigurationName,
            ConfigurationId,
            CriticalityTier,
            CriticalityTierLevel,
            SecuritySeverity,
            Impact,
            RiskFactor_Consequence,
            RiskFactor_Probability,
            AssetCount,
            TotalIssues,
            ImpactedAssets
        | order by CriticalityTier asc, Impact desc, TotalIssues desc, AssetCount desc, ConfigurationId asc
        

  - ReportName: Device_Recommendations_Detailed_v2
    ReportPurpose: Detailed
    SecurityDomain: Endpoint
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let excludeForWindowsServer = dynamic([
            "scid-2090",
            "scid-22"
        ]);

        // ===================== LOOKUP TABLES (short standard texts) =====================
        let CategoryLookup = datatable(Category:string, CategoryDescription:string)
        [
          "Security controls", "Endpoint protection and attack-surface policies that block common malware and attacker techniques.",
          "Network",           "Network security policies that limit attack surface and lateral movement.",
          "BitLocker",         "Full-disk encryption to prevent data exposure on lost or stolen devices.",
          "OS",                "Operating system baseline hardening and core protections.",
          "Credentials",       "Controls that prevent credential theft and reuse.",
          "Browser",           "Safe browsing and web threat protections.",
          "Application",       "Application control and exploit protection to restrict unauthorized code execution.",
          "Device",            "General endpoint configuration and health requirements.",
          "Audit",             "Monitoring-focused baselines to validate configuration posture."
        ];

        let SubCategoryLookup = datatable(Subcategory:string, SubCategoryDescription:string)
        [
          "EDR",                        "Defender for Endpoint sensor presence and reporting health.",
          "Attack Surface Reduction",   "Blocks common malware execution paths from email, web and Office content.",
          "Firewall",                   "Enforces inbound/outbound traffic policy and host firewall state.",
          "Antivirus",                  "Ensures Microsoft Defender Antivirus is active and properly configured.",
          "BitLocker",                  "Enforces full-disk encryption and key escrow.",
          "Exploit Guard",              "Hardens OS/apps against memory corruption and exploit chains.",
          "Authentication",             "Strengthens sign-in security and protects credential boundaries.",
          "Remote Access",              "Restricts remote shell/administrative entry points.",
          "TLS/Communication",          "Requires secure protocols and prevents crypto downgrade.",
          "Removable Storage",          "Controls external media to reduce malware risk and data exfiltration."
        ];

        // ===================== PARAMETERS =====================
        let lookback         = 30d;
        let onlyApplicable   = true;
        let osFilter         = dynamic([]);          // e.g. ["Windows10","Windows11","Linux","macOS"]
        let categoryFilter   = dynamic([]);          // e.g. ["Security controls","Network"]
        let idFilter         = dynamic([]);          // e.g. ["scid-2500","scid-10003"]
        let nameSearch       = "";
        let sortByImpactDesc = true;
        let SecurityDomain   = "Endpoint";

        // ===================== DEVICEINFO (latest) =====================
        let DeviceInfoLatest =
            DeviceInfo
            | where TimeGenerated >= ago(lookback)
            | summarize arg_max(TimeGenerated, *) by DeviceId
            | project
                DeviceId,
                DI_DeviceName      = DeviceName,
                DI_OSPlatform      = OSPlatform,
                DI_MachineGroup    = MachineGroup,
                DI_AssetValue      = tostring(AssetValue),
                DI_ExposureLevel   = tostring(ExposureLevel),
                DI_AzureResourceId = tostring(AzureResourceId),
                DI_AadDeviceId     = tostring(AadDeviceId);

        // ===================== EXPOSURE GRAPH (Endpoint assets, join via aadDeviceId) =====================
        let EG_Assets =
            ExposureGraphNodes
            | extend CriticalityLevel = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                tostring(NodeProperties.criticalityLevel.criticalityLevel)
              ))
            , CriticalityRuleBased = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
              ))
            , CriticalityRuleNames = coalesce(
                strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
              )
            | extend EG_AadDeviceId = tostring(coalesce(
                NodeProperties.rawData.aadDeviceId,
                NodeProperties.raw.aadDeviceId,
                NodeProperties.aadDeviceId
              ))
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            // ------------------------------------------------------------------------------
            | project
                EG_AadDeviceId,
                EG_AssetName    = NodeName,
                EG_AssetLabel   = NodeLabel,
                EG_AssetProps   = NodeProperties,
                EG_CriticalityLevel = CriticalityLevel,
                EG_CriticalityRuleBased = CriticalityRuleBased,
                EG_CriticalityRuleNames = CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // ===================== TVM SECURE CONFIG (core) =====================
        let TVM_Base =
        DeviceTvmSecureConfigurationAssessment
        | where TimeGenerated >= ago(lookback)
        | where (array_length(osFilter) == 0 or OSPlatform in~ (osFilter))
        | where (array_length(idFilter) == 0 or ConfigurationId in~ (idFilter))
        | where (nameSearch == "" or tostring(DeviceName) contains nameSearch)
        | where not (OSPlatform contains "WindowsServer" and ConfigurationId in~ (excludeForWindowsServer))
        | where iff(onlyApplicable, IsApplicable == 1, true)
        | join kind=leftouter (
            DeviceTvmSecureConfigurationAssessmentKB
            | project
                ConfigurationId,
                KB_ConfigurationName        = ConfigurationName,
                KB_ConfigurationCategory    = ConfigurationCategory,
                KB_ConfigurationSubcategory = ConfigurationSubcategory,
                KB_Impact                   = toint(ConfigurationImpact),
                KB_RiskDescription          = tostring(RiskDescription),
                KB_Description              = tostring(ConfigurationDescription),
                KB_Remediation              = tostring(RemediationOptions),
                KB_Benchmarks               = ConfigurationBenchmarks
        ) on ConfigurationId
        | where (array_length(categoryFilter) == 0 or KB_ConfigurationCategory in~ (categoryFilter))
        | extend ImpactInt = toint(coalesce(KB_Impact, toint(ConfigurationImpact)))
        | extend
            Category          = coalesce(KB_ConfigurationCategory, ConfigurationCategory),
            Subcategory       = KB_ConfigurationSubcategory,
            ConfigurationName = coalesce(KB_ConfigurationName, tostring(ConfigurationId)),
            IsCompliant       = tobool(IsCompliant),
            IsApplicable      = tobool(IsApplicable)
        | extend
            RecommendedAction =
                case(
                    ImpactInt >= 9, "Fix immediately - Security Change Queue / Intune / GPO rollout",
                    ImpactInt == 8, "Schedule within quarterly hardening cycle",
                    ImpactInt >= 5 and ImpactInt < 8, "Fix opportunistically (during upgrades / refresh)",
                    "Monitor, document as baseline exceptions"
                ),
            SecuritySeverity =
                case(
                    ImpactInt == 10, "Very High",
                    ImpactInt == 9,  "High",
                    ImpactInt == 8,  "Medium-High",
                    ImpactInt >= 5,  "Medium",
                    "Low Risk"
                ),
            SecuritySeverityDescription =
                case(
                    ImpactInt == 10, "If this configuration is not applied, attackers gain a major foothold or common attack vector remains wide open.",
                    ImpactInt == 9,  "Strongly recommended to fix ASAP; commonly exploited by real-world malware and ransomware.",
                    ImpactInt == 8,  "Important baseline security hardening; reduces attack surface and lateral movement.",
                    ImpactInt >= 5,  "Security best practice; helps reduce exposure but less frequently exploited.",
                    "Hardening / hygiene controls; helps, but attackers less likely to target."
                ),
            SortKey = iff(sortByImpactDesc, todouble(ImpactInt), 0.0)
        | summarize arg_max(TimeGenerated, *) by DeviceId, ConfigurationId
        | where IsCompliant == false
        | lookup CategoryLookup on Category
        | lookup SubCategoryLookup on Subcategory
        | extend
            CategoryDescription    = coalesce(CategoryDescription, "Category description not defined"),
            SubCategoryDescription = coalesce(SubCategoryDescription, "Subcategory description not defined");

        // ===================== ENRICH WITH DEVICEINFO + EXPOSURE GRAPH (join by AAD device id) =====================
        TVM_Base
        | join kind=leftouter (DeviceInfoLatest) on DeviceId
        | join kind=leftouter (
            EG_Assets
            | where isnotempty(EG_AadDeviceId)
        ) on $left.DI_AadDeviceId == $right.EG_AadDeviceId
        | where isnotempty(EG_CriticalityLevel)
        | where EG_IsExcluded == false
        | extend Criticality = toint(EG_CriticalityLevel)
        | extend SecurityDomain = SecurityDomain
        | extend CriticalityTier = toint(Criticality)
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 3, "Low - tier 3",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 0, "Critical - tier 0",
                "Unknown - unmapped"
            )
        | extend
            AssetName  = coalesce(DI_DeviceName, DeviceName),
            AssetLabel = EG_AssetLabel,
            RiskFactor_Probability = iff(EG_IsCustomerFacing == true, 1, 0),
            RiskFactor_Consequence = 0
        | project
            TimeGenerated,
            SecurityDomain,
            AssetName,
            AssetLabel,
            RiskFactor_Consequence,
            RiskFactor_Probability,
            DeviceId,
            DeviceName           = coalesce(DI_DeviceName, DeviceName),
            OSPlatform           = coalesce(DI_OSPlatform, OSPlatform),
            Category,
            CategoryDescription,
            Subcategory,
            SubCategoryDescription,
            ConfigurationId,
            ConfigurationName,
            CriticalityTier,
            CriticalityTierLevel,
            Impact               = ImpactInt,
            SecuritySeverity,
            SecuritySeverityDescription,
            RecommendedAction,
            RiskDescription      = KB_RiskDescription,
            ConfigurationDescription = KB_Description,
            RemediationOptions   = KB_Remediation,
            Benchmarks           = KB_Benchmarks,
            EG_IsCustomerFacing,
            EG_IsExcluded,
            IsApplicable,
            IsCompliant,
            DI_MachineGroup,
            DI_AssetValue,
            DI_ExposureLevel,
            DI_AzureResourceId,
            DI_AadDeviceId,
            EG_AssetName,
            EG_AssetLabel,
            EG_CriticalityRuleBased,
            EG_CriticalityRuleNames,
            EG_AssetProps
        | order by CriticalityTier asc, Impact desc, AssetName asc, ConfigurationId asc

  - ReportName: Device_Recommendations_Detailed_BucketFilter_v2
    ReportPurpose: Detailed
    SecurityDomain: Endpoint
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let excludeForWindowsServer = dynamic([
            "scid-2090",
            "scid-22"
        ]);

        // ===================== LOOKUP TABLES (short standard texts) =====================
        let CategoryLookup = datatable(Category:string, CategoryDescription:string)
        [
          "Security controls", "Endpoint protection and attack-surface policies that block common malware and attacker techniques.",
          "Network",           "Network security policies that limit attack surface and lateral movement.",
          "BitLocker",         "Full-disk encryption to prevent data exposure on lost or stolen devices.",
          "OS",                "Operating system baseline hardening and core protections.",
          "Credentials",       "Controls that prevent credential theft and reuse.",
          "Browser",           "Safe browsing and web threat protections.",
          "Application",       "Application control and exploit protection to restrict unauthorized code execution.",
          "Device",            "General endpoint configuration and health requirements.",
          "Audit",             "Monitoring-focused baselines to validate configuration posture."
        ];

        let SubCategoryLookup = datatable(Subcategory:string, SubCategoryDescription:string)
        [
          "EDR",                        "Defender for Endpoint sensor presence and reporting health.",
          "Attack Surface Reduction",   "Blocks common malware execution paths from email, web and Office content.",
          "Firewall",                   "Enforces inbound/outbound traffic policy and host firewall state.",
          "Antivirus",                  "Ensures Microsoft Defender Antivirus is active and properly configured.",
          "BitLocker",                  "Enforces full-disk encryption and key escrow.",
          "Exploit Guard",              "Hardens OS/apps against memory corruption and exploit chains.",
          "Authentication",             "Strengthens sign-in security and protects credential boundaries.",
          "Remote Access",              "Restricts remote shell/administrative entry points.",
          "TLS/Communication",          "Requires secure protocols and prevents crypto downgrade.",
          "Removable Storage",          "Controls external media to reduce malware risk and data exfiltration."
        ];

        // ===================== PARAMETERS =====================
        let lookback         = 30d;
        let onlyApplicable   = true;
        let osFilter         = dynamic([]);          // e.g. ["Windows10","Windows11","Linux","macOS"]
        let categoryFilter   = dynamic([]);          // e.g. ["Security controls","Network"]
        let idFilter         = dynamic([]);          // e.g. ["scid-2500","scid-10003"]
        let nameSearch       = "";
        let sortByImpactDesc = true;
        let SecurityDomain   = "Endpoint";

        // ===================== DEVICEINFO (latest) =====================
        let DeviceInfoLatest =
            DeviceInfo
            | where TimeGenerated >= ago(lookback)
            | summarize arg_max(TimeGenerated, *) by DeviceId
            | project
                DeviceId,
                DI_DeviceName      = DeviceName,
                DI_OSPlatform      = OSPlatform,
                DI_MachineGroup    = MachineGroup,
                DI_AssetValue      = tostring(AssetValue),
                DI_ExposureLevel   = tostring(ExposureLevel),
                DI_AzureResourceId = tostring(AzureResourceId),
                DI_AadDeviceId     = tostring(AadDeviceId);

        // ===================== EXPOSURE GRAPH (Endpoint assets, join via aadDeviceId) =====================
        let EG_Assets =
            ExposureGraphNodes
            | extend CriticalityLevel = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                tostring(NodeProperties.criticalityLevel.criticalityLevel)
              ))
            , CriticalityRuleBased = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
              ))
            , CriticalityRuleNames = coalesce(
                strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
              )
            | extend EG_AadDeviceId = tostring(coalesce(
                NodeProperties.rawData.aadDeviceId,
                NodeProperties.raw.aadDeviceId,
                NodeProperties.aadDeviceId
              ))
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            // ------------------------------------------------------------------------------
            | project
                EG_AadDeviceId,
                EG_AssetName    = NodeName,
                EG_AssetLabel   = NodeLabel,
                EG_AssetProps   = NodeProperties,
                EG_CriticalityLevel = CriticalityLevel,
                EG_CriticalityRuleBased = CriticalityRuleBased,
                EG_CriticalityRuleNames = CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // ===================== TVM SECURE CONFIG (core) =====================
        let TVM_Base =
        DeviceTvmSecureConfigurationAssessment
        | where TimeGenerated >= ago(lookback)
        | where (array_length(osFilter) == 0 or OSPlatform in~ (osFilter))
        | where (array_length(idFilter) == 0 or ConfigurationId in~ (idFilter))
        | where (nameSearch == "" or tostring(DeviceName) contains nameSearch)
        | where not (OSPlatform contains "WindowsServer" and ConfigurationId in~ (excludeForWindowsServer))
        | where iff(onlyApplicable, IsApplicable == 1, true)
        | join kind=leftouter (
            DeviceTvmSecureConfigurationAssessmentKB
            | project
                ConfigurationId,
                KB_ConfigurationName        = ConfigurationName,
                KB_ConfigurationCategory    = ConfigurationCategory,
                KB_ConfigurationSubcategory = ConfigurationSubcategory,
                KB_Impact                   = toint(ConfigurationImpact),
                KB_RiskDescription          = tostring(RiskDescription),
                KB_Description              = tostring(ConfigurationDescription),
                KB_Remediation              = tostring(RemediationOptions),
                KB_Benchmarks               = ConfigurationBenchmarks
        ) on ConfigurationId
        | where (array_length(categoryFilter) == 0 or KB_ConfigurationCategory in~ (categoryFilter))
        | extend ImpactInt = toint(coalesce(KB_Impact, toint(ConfigurationImpact)))
        | extend
            Category          = coalesce(KB_ConfigurationCategory, ConfigurationCategory),
            Subcategory       = KB_ConfigurationSubcategory,
            ConfigurationName = coalesce(KB_ConfigurationName, tostring(ConfigurationId)),
            IsCompliant       = tobool(IsCompliant),
            IsApplicable      = tobool(IsApplicable)
        | extend
            RecommendedAction =
                case(
                    ImpactInt >= 9, "Fix immediately - Security Change Queue / Intune / GPO rollout",
                    ImpactInt == 8, "Schedule within quarterly hardening cycle",
                    ImpactInt >= 5 and ImpactInt < 8, "Fix opportunistically (during upgrades / refresh)",
                    "Monitor, document as baseline exceptions"
                ),
            SecuritySeverity =
                case(
                    ImpactInt == 10, "Very High",
                    ImpactInt == 9,  "High",
                    ImpactInt == 8,  "Medium-High",
                    ImpactInt >= 5,  "Medium",
                    "Low Risk"
                ),
            SecuritySeverityDescription =
                case(
                    ImpactInt == 10, "If this configuration is not applied, attackers gain a major foothold or common attack vector remains wide open.",
                    ImpactInt == 9,  "Strongly recommended to fix ASAP; commonly exploited by real-world malware and ransomware.",
                    ImpactInt == 8,  "Important baseline security hardening; reduces attack surface and lateral movement.",
                    ImpactInt >= 5,  "Security best practice; helps reduce exposure but less frequently exploited.",
                    "Hardening / hygiene controls; helps, but attackers less likely to target."
                ),
            SortKey = iff(sortByImpactDesc, todouble(ImpactInt), 0.0)
        | summarize arg_max(TimeGenerated, *) by DeviceId, ConfigurationId
        | where IsCompliant == false
        | lookup CategoryLookup on Category
        | lookup SubCategoryLookup on Subcategory
        | extend
            CategoryDescription    = coalesce(CategoryDescription, "Category description not defined"),
            SubCategoryDescription = coalesce(SubCategoryDescription, "Subcategory description not defined");

        // ===================== ENRICH WITH DEVICEINFO + EXPOSURE GRAPH (join by AAD device id) =====================
        TVM_Base
        | join kind=leftouter (DeviceInfoLatest) on DeviceId
        | join kind=leftouter (
            EG_Assets
            | where isnotempty(EG_AadDeviceId)
        ) on $left.DI_AadDeviceId == $right.EG_AadDeviceId
        | where isnotempty(EG_CriticalityLevel)
        | where EG_IsExcluded == false
        | extend Criticality = toint(EG_CriticalityLevel)
        | extend SecurityDomain = SecurityDomain
        | extend CriticalityTier = toint(Criticality)
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 3, "Low - tier 3",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 0, "Critical - tier 0",
                "Unknown - unmapped"
            )
        | extend
            AssetName  = coalesce(DI_DeviceName, DeviceName),
            AssetLabel = EG_AssetLabel,
            RiskFactor_Probability = iff(EG_IsCustomerFacing == true, 1, 0),
            RiskFactor_Consequence = 0
        // Bucket filter
        | extend DeviceKey = iif(isnotempty(DI_AadDeviceId), DI_AadDeviceId, AssetName)
        __BUCKET_FILTER__
        | project
            TimeGenerated,
            SecurityDomain,
            AssetName,
            AssetLabel,
            RiskFactor_Consequence,
            RiskFactor_Probability,
            DeviceId,
            DeviceName           = coalesce(DI_DeviceName, DeviceName),
            OSPlatform           = coalesce(DI_OSPlatform, OSPlatform),
            Category,
            CategoryDescription,
            Subcategory,
            SubCategoryDescription,
            ConfigurationId,
            ConfigurationName,
            CriticalityTier,
            CriticalityTierLevel,
            Impact               = ImpactInt,
            SecuritySeverity,
            SecuritySeverityDescription,
            RecommendedAction,
            RiskDescription      = KB_RiskDescription,
            ConfigurationDescription = KB_Description,
            RemediationOptions   = KB_Remediation,
            Benchmarks           = KB_Benchmarks,
            EG_IsCustomerFacing,
            EG_IsExcluded,
            IsApplicable,
            IsCompliant,
            DI_MachineGroup,
            DI_AssetValue,
            DI_ExposureLevel,
            DI_AzureResourceId,
            DI_AadDeviceId,
            EG_AssetName,
            EG_AssetLabel,
            EG_CriticalityRuleBased,
            EG_CriticalityRuleNames,
            EG_AssetProps
        | order by CriticalityTier asc, Impact desc, AssetName asc, ConfigurationId asc

       
  - ReportName: Azure_Recommendations_Summary_v2
    ReportPurpose: Comprehensive Azure security recommendations analysis script that aggregates findings by asset criticality tiers, security severity levels, and impact scores. Provides complete visibility into all impacted assets without limitations.
    SecurityDomain: Azure
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
      - "AssetCount"
      - "TotalIssues"
      - "ImpactedAssets"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        // 1) Assets
        let Assets =
            ExposureGraphNodes
            | where tostring(NodeProperties.rawData.environmentName) contains "Azure"
            | extend CriticalityLevel = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                tostring(NodeProperties.criticalityLevel.criticalityLevel)
              ))
            | extend CriticalityRuleBased = toint(coalesce(
                tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
              ))
            | extend CriticalityRuleNames = coalesce(
                strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
              )
            // asset risk flags (if present)
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // 2) Findings
        let Findings =
            ExposureGraphNodes
            | mv-expand Category = Categories
            | where tostring(Category) contains "finding"
            | where NodeLabel !contains "cve"
            | project
                FindingNodeId     = NodeId,
                FindingName       = NodeName,
                FindingLabel      = NodeLabel,
                FindingCategories = Categories,
                FindingProps      = NodeProperties;

        // 3) Edges
        let Edges =
            ExposureGraphEdges
            | where tostring(EdgeLabel) contains "affecting"
            | extend EdgeProps = column_ifexists("EdgeProperties", dynamic({}))
            | project SourceNodeId, TargetNodeId, EdgeLabel, EdgeProps;

        // 4) Asset ↔ Finding
        let AF_edges_oneway =
            Edges
            | join kind=inner (Assets)   on $left.SourceNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.TargetNodeId == $right.FindingNodeId
            | project AssetNodeId, AssetName, AssetLabel,
                      FindingNodeId, FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames,
                      EG_IsCustomerFacing, EG_IsExcluded;

        let AF_edges_otherway =
            Edges
            | join kind=inner (Assets)   on $left.TargetNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.SourceNodeId == $right.FindingNodeId
            | project AssetNodeId, AssetName, AssetLabel,
                      FindingNodeId, FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames,
                      EG_IsCustomerFacing, EG_IsExcluded;

        let AF_edges = union AF_edges_oneway, AF_edges_otherway;

        AF_edges
        | summarize
            EdgeLabels           = make_set(EdgeLabel),
            EdgePropsAny         = any(EdgeProps),
            FindingLabel         = any(FindingLabel),
            FindingCategories    = any(FindingCategories),
            FindingProps         = any(FindingProps),
            AssetProps           = any(AssetProps),
            CriticalityLevel     = any(CriticalityLevel),
            CriticalityRuleBased = any(CriticalityRuleBased),
            CriticalityRuleNames = any(CriticalityRuleNames),
            EG_IsCustomerFacing  = any(EG_IsCustomerFacing),
            EG_IsExcluded        = any(EG_IsExcluded)
          by AssetNodeId, AssetName, AssetLabel, FindingName
        // filter excluded assets
        | where EG_IsExcluded == false

        // Properties bag
        | extend Properties =
            bag_merge(
                bag_pack("finding", FindingProps),
                bag_pack("raw", iif(isnull(FindingProps.rawData), dynamic({}), FindingProps.rawData)),
                bag_pack("edge", EdgePropsAny)
            )

        | extend SubCategory = tostring(Properties.raw.securityIssue.securityIssue)

        // risk info (from the edge)
        | extend RiskLevel   = tostring(Properties.edge.rawData.risk.riskLevel)
        | extend RiskFactors = todynamic(Properties.edge.rawData.risk.riskFactors)

        // safer “Exposure to the Internet” match (works whether RiskFactors is an array or complex objects)
        | extend RiskFactorsText = tostring(RiskFactors)
        | extend RiskFactor_Probability =
            iif(
                tolower(RiskLevel) == "critical"
                or RiskFactorsText has "Exposure to the Internet",
                1, 0
            )
        | extend RiskFactor_Consequence = 0

        // tier mapping
        | extend CriticalityTier = CriticalityLevel
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 3, "Low - tier 3",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 0, "Critical - tier 0",
                "Unknown - tier"
            )

        | extend Severity = tostring(Properties.raw.severity)
        | extend Impact =
            case(
                tolower(Severity) == "low", 3,
                tolower(Severity) == "medium", 7,
                tolower(Severity) in ("high","critical"), 10,
                999
            )

        // set the fields your risk engine expects
        | extend SecurityDomain      = "Azure"
        | extend ConfigurationId     = "Azure"
        | extend Category            = tostring(FindingLabel)          // or tostring(FindingCategories[0]) if you prefer
        | extend ConfigurationName   = tostring(FindingName)
        | extend SecuritySeverity    = Severity

        | where isnotempty(SecuritySeverity)

        // summarize at “recommendation” level
        | summarize
            AssetCount             = dcount(AssetNodeId),
            TotalIssues            = count(),
            AvgImpact              = avg(Impact),
            MaxImpact              = max(Impact),
            ImpactedAssets         = make_set(AssetName),              // remove limit = no 2nd argument
            SampleFindings         = make_set(FindingName),            // better than FindingLabel here
            RiskFactor_Consequence = max(RiskFactor_Consequence),
            RiskFactor_Probability = max(RiskFactor_Probability)
          by SecurityDomain, Category, SubCategory, ConfigurationName, ConfigurationId, CriticalityTier, CriticalityTierLevel, SecuritySeverity

        | project
            SecurityDomain,
            Category,
            Subcategory          = SubCategory,
            ConfigurationName,
            ConfigurationId,
            CriticalityTier,
            CriticalityTierLevel,
            SecuritySeverity,
            RiskFactor_Consequence,
            RiskFactor_Probability,
            AssetCount,
            TotalIssues,
            AvgImpact = round(AvgImpact, 1),
            MaxImpact = toint(ceiling(MaxImpact)),
            ImpactedAssets,
            SampleFindings

        | order by CriticalityTier asc, MaxImpact desc, AvgImpact desc, AssetCount desc, TotalIssues desc

  - ReportName: Azure_Recommendations_Detailed_v2
    ReportPurpose: Detailed Azure security recommendations analysis script that provides granular view of individual findings with asset criticality tiers, security severity levels, and impact scores for comprehensive security analysis.
    SecurityDomain: Azure
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        // 1) Assets
        let Assets =
            ExposureGraphNodes
            | where tostring(NodeProperties.rawData.environmentName) contains "Azure"
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties.criticalityLevel.criticalityLevel)
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel)
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", ")
                )
            // asset risk flags
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties.rawData.isCustomerFacing,
                NodeProperties.raw.isCustomerFacing
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties.raw.isExcluded
              ))
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded;

        // 2) Findings
        let Findings =
            ExposureGraphNodes
            | mv-expand Category = Categories
            | where tostring(Category) contains "finding"
            | where NodeLabel !contains "cve"
            | project
                FindingNodeId     = NodeId,
                FindingName       = NodeName,
                FindingLabel      = NodeLabel,
                FindingCategories = Categories,
                FindingProps      = NodeProperties;

        // 3) Edges
        let Edges =
            ExposureGraphEdges
            | where tostring(EdgeLabel) contains "affecting"
            | extend EdgeProps = column_ifexists("EdgeProperties", dynamic({}))
            | project SourceNodeId, TargetNodeId, EdgeLabel, EdgeProps;

        // 4) Asset ↔ Finding
        let AF_edges_oneway =
            Edges
            | join kind=inner (Assets)   on $left.SourceNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.TargetNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames,
                      EG_IsCustomerFacing, EG_IsExcluded;

        let AF_edges_otherway =
            Edges
            | join kind=inner (Assets)   on $left.TargetNodeId == $right.AssetNodeId
            | join kind=inner (Findings) on $left.SourceNodeId == $right.FindingNodeId
            | project AssetName, AssetLabel,
                      FindingName, FindingLabel, FindingCategories, FindingProps,
                      EdgeLabel, EdgeProps,
                      AssetProps, CriticalityLevel, CriticalityRuleBased, CriticalityRuleNames,
                      EG_IsCustomerFacing, EG_IsExcluded;

        let AF_edges = union AF_edges_oneway, AF_edges_otherway;

        AF_edges
        | summarize
            EdgeLabels           = make_set(EdgeLabel),
            EdgePropsAny         = any(EdgeProps),
            FindingLabel         = any(FindingLabel),
            FindingCategories    = any(FindingCategories),
            FindingProps         = any(FindingProps),
            AssetProps           = any(AssetProps),
            CriticalityLevel     = any(CriticalityLevel),
            CriticalityRuleBased = any(CriticalityRuleBased),
            CriticalityRuleNames = any(CriticalityRuleNames),
            EG_IsCustomerFacing  = any(EG_IsCustomerFacing),
            EG_IsExcluded        = any(EG_IsExcluded)
          by AssetName, AssetLabel, FindingName
        // filter excluded assets
        | where EG_IsExcluded == false
        | extend Properties =
            bag_merge(
                bag_pack("finding", FindingProps),
                bag_pack("raw", iif(isnull(FindingProps.rawData), dynamic({}), FindingProps.rawData)),
                bag_pack("edge", EdgePropsAny)
            )
        | extend SubCategory = tostring(Properties.raw.securityIssue.securityIssue)

        // ---- risk from edge.rawData.risk ----
        | extend RawCriticality = tostring(Properties.edge.rawData.risk.riskLevel)
        | extend RiskFactors    = todynamic(Properties.edge.rawData.risk.riskFactors)
        | extend RiskFactor_Probability =
            iff(
                EG_IsCustomerFacing == true
                or tolower(RawCriticality) in ("critical","very high")
                or tostring(RiskFactors) has "Exposure to the Internet",
                1, 0
            )
        | extend RiskFactor_Consequence = 0
        // -----------------------------------

        | extend CriticalityTier = CriticalityLevel
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 3, "Low - tier 3",
                CriticalityTier == 2, "Medium - tier 2",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 0, "Critical - tier 0",
                "Unknown - tier"
            )

        | extend Severity = tostring(Properties.raw.severity)
        | extend Impact =
            case(
                tolower(Severity) == "low",                   3,
                tolower(Severity) == "medium",                7,
                tolower(Severity) in ("high","critical"),    10,
                999
            )
        | extend SecurityDomain = "Azure"
        | extend ConfigurationId = "Azure"
        | where isnotempty(Severity)

        | project
            SecurityDomain,
            AssetName,
            AssetLabel,
            Category              = tostring(FindingLabel),
            Subcategory           = SubCategory,
            ConfigurationName     = tostring(FindingName),
            ConfigurationId,
            CriticalityLevel,
            CriticalityRuleBased,
            CriticalityRuleNames,
            CriticalityTier,
            CriticalityTierLevel,
            SecuritySeverity      = Severity,
            Impact,
            RawCriticality,
            RiskFactors,
            RiskFactor_Probability,
            RiskFactor_Consequence,
            EG_IsCustomerFacing,
            EG_IsExcluded,
            EdgeLabels,
            Properties
        | order by CriticalityTier asc, Impact desc, SecuritySeverity asc, AssetName asc
        
  - ReportName: Attack_Paths_Summary_v1
    ReportPurpose: Summary
    SecurityDomain: Azure
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
      - "AssetCount"
      - "TotalIssues"
      - "ImpactedAssets"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)), LabelStr = tolower(tostring(NodeLabel))
            | extend IsInternetFacing = tobool(coalesce(
                       NodeProperties.rawData.exposedToInternet,
                       NodeProperties.rawData.isexposedtointernet,
                       NodeProperties.rawData.IsInternetFacing,
                       NodeProperties.rawData.internetFacing,
                       false
                   )),
                   CriticalityLevel = toint(coalesce(
                       NodeProperties.rawData.criticalityLevel.criticalityLevel,
                       NodeProperties.rawData.criticalityLevel.level,
                       NodeProperties.rawData.criticalityLevel,
                       NodeProperties.rawData.Criticality,
                       999
                   )),
                   SecuritySeverity = tostring(coalesce(
                       NodeProperties.rawData.securitySeverity,
                       NodeProperties.rawData.SecuritySeverity,
                       NodeProperties.rawData.severity,
                       NodeProperties.rawData.Severity,
                       NodeProperties.rawData.riskScore,
                       NodeProperties.rawData.RiskScore,
                       ""
                   )),
                   NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            | extend IsEntryPoint = (CategoriesStr has "ip_address") or (CategoriesStr has "device") or (CategoriesStr has "virtual_machine") or (CategoriesStr has "computer"),
                     IsAzureResource = (CategoriesStr has "environmentazure") or (CategoriesStr has "environmentcloud"),
                     IsInternetExposed = IsInternetFacing;

        let Paths =
            ExposureGraphEdges
            | extend EdgeSecuritySeverity = tostring(coalesce(
                       EdgeProperties.rawData.securitySeverity,
                       EdgeProperties.rawData.SecuritySeverity,
                       EdgeProperties.rawData.severity,
                       EdgeProperties.rawData.Severity,
                       EdgeProperties.rawData.riskScore,
                       EdgeProperties.rawData.RiskScore,
                       ""
                   ))
            | make-graph SourceNodeId --> TargetNodeId with Nodes on NodeId
            | graph-match (S)-[p*1..5]->(T)
                  where S.IsEntryPoint and T.IsAzureResource
                    and T.CriticalityLevel <= 999
                  project Source=S.NodeNameNorm,
                          Target=T.NodeNameNorm,
                          TargetCriticality=T.CriticalityLevel,
                          SourceCategories=S.CategoriesStr,
                          TargetCategories=T.CategoriesStr,
                          SourceIsInternetFacing=S.IsInternetFacing,
                          SourceCriticality=S.CriticalityLevel,
                          SourceSecuritySeverity=S.SecuritySeverity,
                          TargetSecuritySeverity=T.SecuritySeverity,
                          Path=p,
                          PathLen=array_length(p);

        Paths
        | extend PathJson = tostring(Path)
        | mv-expand HopObj = Path
        | extend EdgeLabel = coalesce(tostring(HopObj.EdgeLabel), tostring(HopObj.Label), tostring(HopObj.EdgeType), "")
        | extend EdgeLabelLower = tolower(EdgeLabel)
        | summarize 
            HasCredentials = any(EdgeLabelLower in ("has credentials of", "frequently logged in by")),
            HasAuth = any(EdgeLabelLower == "can authenticate to"),
            HasPermissions = any(EdgeLabelLower in ("has permissions to", "has role on")),
            SourceSecuritySeverities = make_set(SourceSecuritySeverity),
            TargetSecuritySeverities = make_set(TargetSecuritySeverity),
            MaxSourceCriticality = max(SourceCriticality),
            MaxTargetCriticality = max(TargetCriticality)
            by Source, Target, TargetCriticality, SourceCategories, TargetCategories, SourceIsInternetFacing, SourceCriticality, PathLen
        | extend EntryPointType = case(
            SourceCategories has "virtual_machine", "Virtual machine",
            SourceCategories has "device", "Device", 
            SourceCategories has "ip_address", "IP address",
            SourceCategories has "computer", "Device",
            "Entry point"
        )
        | extend TargetType = case(
            TargetCategories has "key" or TargetCategories has "vault" or TargetCategories has "secret", "Key/Secret Management",
            TargetCategories has "storage" or TargetCategories has "object", "Storage Service",
            TargetCategories has "ai" or TargetCategories has "cognitive" or TargetCategories has "model", "AI/ML Service",
            TargetCategories has "database" or TargetCategories has "sql", "Database Service",
            TargetCategories has "virtual_machine" or TargetCategories has "compute", "Compute Service",
            TargetCategories has "subscription", "Subscription",
            TargetCategories has "function" or TargetCategories has "app", "Application Service",
            TargetCategories has "network", "Network Service",
            TargetCategories has "log", "Logging Service",
            TargetCategories has "environmentazure", "Azure Resource",
            TargetCategories has "environmentaws", "AWS Resource", 
            TargetCategories has "environmentgcp", "GCP Resource",
            "Cloud Resource"
        )
        | extend AttackBehavior = case(
            HasCredentials and HasAuth, "credential theft and authentication",
            HasCredentials, "credential access", 
            HasPermissions, "privilege escalation",
            "lateral movement"
        )
        | extend SecuritySeverityScore = case(
            SourceIsInternetFacing and TargetCriticality == 0, 5,
            SourceIsInternetFacing and TargetCriticality == 1, 4,
            SourceIsInternetFacing and TargetCriticality == 2, 3,
            TargetCriticality == 0, 4,
            TargetCriticality == 1, 3,
            TargetCriticality == 2, 2,
            1
        )
        | extend SecuritySeverity = case(
            SecuritySeverityScore == 5, "Very High",
            SecuritySeverityScore == 4, "High", 
            SecuritySeverityScore == 3, "Medium-High",
            SecuritySeverityScore == 2, "Medium",
            "Low"
        )
        | extend AttackPattern = strcat(
            case(SourceIsInternetFacing, "Internet exposed ", ""),
            EntryPointType,
            " with ", SecuritySeverity, " severity vulnerabilities allows ",
            AttackBehavior, " to ",
            case(TargetCriticality == 0, "Critical ", ""),
            TargetType
        )
        | summarize 
            InstanceCount = count(),
            EntryPointTypes = make_set(EntryPointType),
            TargetTypes = make_set(TargetType),
            AttackBehaviors = make_set(AttackBehavior),
            MinCriticality = min(TargetCriticality),
            MinSourceCriticality = min(SourceCriticality),
            MaxSecuritySeverityScore = max(SecuritySeverityScore),
            SecuritySeverities = make_set(SecuritySeverity),
            EntryPoints = make_set(Source),
            Targets = make_set(Target),
            SampleTargetCategories = make_set(TargetCategories),
            SourceSecuritySeverities = make_set(SourceSecuritySeverities),
            TargetSecuritySeverities = make_set(TargetSecuritySeverities)
            by AttackPattern, TargetType, SecuritySeverity
        | extend AttackPathNameWithCount = strcat(AttackPattern, " (", InstanceCount, ")")
        | extend PrimaryEntryPointType = tostring(EntryPointTypes[0])
        | extend PrimarySecuritySeverity = tostring(SecuritySeverities[0])
        | extend CriticalityTier = case(
            MinSourceCriticality == 0, 0,
            MinSourceCriticality == 1, 1, 
            MinSourceCriticality == 2, 2,
            3
        )
        | extend CriticalityTierLevel = case(
            CriticalityTier == 0, "Critical - tier 0",
            CriticalityTier == 1, "High - tier 1",
            CriticalityTier == 2, "Medium - tier 2", 
            "Low - tier 3"
        )
        | project 
            // Excel/risk-scoring schema
            SecurityDomain       = "Azure",
            Category             = "mdcSecurityRecommendation",
            Subcategory          = "Vulnerability",
            ConfigurationName    = AttackPathNameWithCount,
            ConfigurationId      = "attackpath",
            Impact               = SecuritySeverityScore,
            SecuritySeverity     = PrimarySecuritySeverity,
            CriticalityTier      = CriticalityTier,
            CriticalityTierLevel = CriticalityTierLevel,
            RiskConsequenceScore = int(0),
            RiskProbabilityScore = int(0),
            RiskScoreTotal       = int(0),
            AssetCount           = InstanceCount,
            TotalIssues          = InstanceCount,
            ImpactedAssets       = strcat_array(Targets, ", ")
        | order by 
            case(SecuritySeverity == "Very High", 1,
                 SecuritySeverity == "High", 2,
                 SecuritySeverity == "Medium-High", 3,
                 SecuritySeverity == "Medium", 4, 5),
            MinCriticality asc, 
            InstanceCount desc

  - ReportName: Attack_Paths_Detailed_v2_Credential_Based_Lateral_Movement
    ReportPurpose: Attack Paths with Secrets, userCookies, ConnectionStrings. Device -> Credential -> Target. Key Detection -> Tier escalation attacks
    SecurityDomain: SecurityDomain
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)),
                     LabelStr      = tolower(tostring(NodeLabel))
            | extend NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            // Criticality extraction
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties.criticalityLevel.criticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", "),
                    ""
                )
            // Asset risk flags
            | extend EG_IsCustomerFacing =
                tobool(coalesce(
                    NodeProperties.rawData.isCustomerFacing,
                    NodeProperties.raw.isCustomerFacing,
                    false
                ))
            | extend EG_IsExcluded =
                tobool(coalesce(
                    NodeProperties.rawData.isExcluded,
                    NodeProperties.raw.isExcluded,
                    false
                ))
            // Risk factors
            | extend RiskFactors =
                todynamic(coalesce(
                    tostring(NodeProperties.rawData.risk.riskFactors),
                    tostring(NodeProperties.risk.riskFactors),
                    "[]"
                ))
            | extend RawCriticality =
                tostring(coalesce(
                    NodeProperties.rawData.criticality,
                    NodeProperties.criticality,
                    ""
                ))
            | extend RiskFactor_Probability =
                iff(
                    EG_IsCustomerFacing == true
                    or tolower(RawCriticality) in ("critical", "very high")
                    or tostring(RiskFactors) has "Exposure to the Internet",
                    1, 0
                )
            | extend RiskFactor_Consequence = 0
            | extend IsEntryPoint =
                        (CategoriesStr has "ip_address")
                     or (CategoriesStr has "device")
                     or (CategoriesStr has "virtual_machine")
                     or (CategoriesStr has "computer"),
                     IsAzureResource =
                        (CategoriesStr has "environmentazure")
                     or (CategoriesStr has "environmentcloud")
            | extend CriticalityTier =
                case(
                    CriticalityLevel == 0, 0,
                    CriticalityLevel == 1, 1,
                    CriticalityLevel == 2, 2,
                    3
                )
            | extend CriticalityTierLevel =
                case(
                    CriticalityTier == 0, "Critical - tier 0",
                    CriticalityTier == 1, "High - tier 1",
                    CriticalityTier == 2, "Medium - tier 2",
                    "Low - tier 3"
                )
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityTier,
                CriticalityTierLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded,
                IsEntryPoint,
                IsAzureResource,
                RiskFactor_Probability,
                RiskFactor_Consequence,
                RawCriticality,
                RiskFactors;

        // Find credentials that exist on source devices/systems
        let CredentialsOnDevices =
            ExposureGraphEdges
            | where EdgeLabel in ("contains", "defined in", "runs on", "has credentials of")
            | where SourceNodeLabel in (
                "device",
                "computer-account",
                "microsoft.compute/virtualmachines",
                "microsoft.web/sites_webapp",
                "microsoft.storage/storageaccounts",
                "user",
                "serviceprincipal"
            )
            | where TargetNodeLabel in (
                "azure-active-directory-app-secret",
                "user-azure-cli-secret",
                "azure-storage-shared-access-signature",
                "azure-storage-connection-string",
                "azure-database-connection-string",
                "azure-active-directory-user-credentials",
                "service-principal-azure-cli-secret",
                "entra-userCookie"
            )
            | project
                SourceDeviceNodeId    = SourceNodeId,
                SourceDeviceNodeName  = SourceNodeName,
                SourceDeviceNodeLabel = SourceNodeLabel,
                CredentialNodeId      = TargetNodeId,
                CredentialNodeName    = TargetNodeName,
                CredentialNodeLabel   = TargetNodeLabel
            // Deduplicate at source level
            | summarize
                SourceDevices        = make_set(SourceDeviceNodeName),
                SourceDeviceTypes    = make_set(SourceDeviceNodeLabel),
                SourceDeviceCount    = dcount(SourceDeviceNodeId),
                FirstSourceDevice    = any(SourceDeviceNodeId),
                FirstSourceDeviceName = any(SourceDeviceNodeName),
                FirstSourceDeviceLabel = any(SourceDeviceNodeLabel)
              by CredentialNodeId, CredentialNodeName, CredentialNodeLabel;

        // Main attack path query - 2 Hop version (simplified for clarity)
        CredentialsOnDevices
        | join kind=inner (
            ExposureGraphEdges
            | where EdgeLabel in ("has credentials of", "can authenticate as", "can authenticate to")
        ) on $left.CredentialNodeId == $right.SourceNodeId
        | join kind=inner (
            ExposureGraphEdges
            | where EdgeLabel in ("can authenticate to", "runs on", "has permissions to", "has role on")
            | where TargetNodeLabel in (
                "microsoft.compute/virtualmachines",
                "microsoft.compute/virtualmachines/extensions",
                "device",
                "computer-account",
                "microsoft.web/sites_webapp",
                "microsoft.sql/servers",
                "microsoft.storage/storageaccounts",
                "microsoft.keyvault/vaults",
                "microsoft.cognitiveservices/accounts",
                "microsoft.cognitiveservices/accounts_openai",
                "microsoft.operationalinsights/workspaces",
                "subscriptions",
                "resourcegroups"
            )
        ) on $left.TargetNodeId == $right.SourceNodeId

        // Filter out same-device scenarios
        | where FirstSourceDevice != TargetNodeId1

        // Deduplicate by unique attack path combination
        | summarize
            SourceDevices              = any(SourceDevices),
            SourceDeviceTypes          = any(SourceDeviceTypes),
            SourceDeviceCount          = any(SourceDeviceCount),
            FirstSourceDevice          = any(FirstSourceDevice),
            FirstSourceDeviceName      = any(FirstSourceDeviceName),
            FirstSourceDeviceLabel     = any(FirstSourceDeviceLabel),
            CredentialNodeName         = any(CredentialNodeName),
            CredentialNodeLabel        = any(CredentialNodeLabel),
            IntermediateIdentity       = any(TargetNodeName),
            IntermediateIdentityLabel  = any(TargetNodeLabel),
            EdgeLabel                  = any(EdgeLabel1),
            TargetAsset                = any(TargetNodeId1),
            TargetAssetName            = any(TargetNodeName1),
            TargetAssetLabel           = any(TargetNodeLabel1)
          by CredentialNodeId, TargetNodeId1  // Unique credential + target combination

        // Enrich with source device node info
        | join kind=leftouter (Nodes) on $left.FirstSourceDevice == $right.AssetNodeId

        // Enrich with target asset node info
        | join kind=leftouter (Nodes) on $left.TargetAsset == $right.AssetNodeId

        | extend
            SourceDeviceCriticality      = CriticalityTier,
            SourceDeviceCriticalityLevel = CriticalityTierLevel,
            SourceIsCustomerFacing       = EG_IsCustomerFacing,
            TargetCriticality            = CriticalityTier1,
            TargetCriticalityLevel       = CriticalityTierLevel1,
            TargetIsCustomerFacing       = EG_IsCustomerFacing1,
            TargetCriticalityRuleBased   = CriticalityRuleBased1,
            TargetCriticalityRuleNames   = CriticalityRuleNames1,
            TargetRiskProbability        = RiskFactor_Probability1

        // Calculate tier escalation
        | extend TierEscalation =
            case(
                SourceDeviceCriticality > TargetCriticality, SourceDeviceCriticality - TargetCriticality,
                0
            )
        | extend IsLateralMovement = TierEscalation > 0
        | extend LateralMovementType =
            case(
                TierEscalation >= 3, "Privilege Escalation: User Workstation to Domain Controller",
                TierEscalation == 2, "Privilege Escalation: Standard Server to Critical Infrastructure",
                TierEscalation == 1, "Privilege Escalation: Single Tier Elevation",
                "Direct Access: Single-Hop Compromise"
            )

        // Enhanced security scoring
        | extend SecuritySeverityScore =
            case(
                TierEscalation >= 3 and TargetCriticality == 0, 10,
                TierEscalation == 2 and TargetCriticality == 0, 9,
                TierEscalation == 1 and TargetCriticality == 0, 8,
                SourceIsCustomerFacing and TargetCriticality == 0, 9,
                TierEscalation == 2 and TargetCriticality == 1, 7,
                TierEscalation == 1 and TargetCriticality == 1, 6,
                SourceIsCustomerFacing and TargetCriticality == 1, 6,
                TierEscalation >= 1 and TargetCriticality == 2, 5,
                SourceIsCustomerFacing and TargetCriticality == 2, 4,
                TargetCriticality == 0, 7,
                TargetCriticality == 1, 5,
                TargetCriticality == 2, 3,
                1
            )
        | extend SecuritySeverityLevel =
            case(
                SecuritySeverityScore >= 9, "Critical",
                SecuritySeverityScore >= 7, "Very High",
                SecuritySeverityScore >= 5, "High",
                SecuritySeverityScore >= 3, "Medium-High",
                SecuritySeverityScore >= 2, "Medium",
                "Low"
            )
        | extend SecurityDomain =
            case(
                TargetAssetLabel in ("device", "computer-account", "microsoft.compute/virtualmachines"), "Endpoint",
                TargetAssetLabel in ("microsoft.web/sites_webapp", "microsoft.sql/servers", "microsoft.storage/storageaccounts"), "Data & Applications",
                TargetAssetLabel in ("subscriptions", "resourcegroups"), "Management Plane",
                "Cloud Resources"
            )
        | extend Category =
            case(
                IsLateralMovement, "AttackPath_LateralMovement",
                "AttackPath_DirectAccess"
            )
        | extend Subcategory =
            case(
                TierEscalation >= 3, strcat("Tier ", SourceDeviceCriticality, " to Tier ", TargetCriticality, " - Critical Privilege Escalation"),
                TierEscalation == 2, strcat("Tier ", SourceDeviceCriticality, " to Tier ", TargetCriticality, " - High Privilege Escalation"),
                TierEscalation == 1, strcat("Tier ", SourceDeviceCriticality, " to Tier ", TargetCriticality, " - Moderate Privilege Escalation"),
                "Direct Access - Same Tier"
            )

        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName  = IntermediateIdentity,
            AssetLabel = IntermediateIdentityLabel,
            ConfigurationName = FirstSourceDeviceName,
            ConfigurationId   = CredentialNodeLabel,
            TierEscalation,
            SourceDevice = FirstSourceDeviceName,
            SourceDeviceType = FirstSourceDeviceLabel,
            SourceDeviceCriticality = SourceDeviceCriticalityLevel,
            SourceDeviceTier = SourceDeviceCriticality,
            TotalSourceDevicesWithCredential = SourceDeviceCount,
            AllSourceDevices = SourceDevices,
            CredentialType = CredentialNodeLabel,
            CredentialNode = CredentialNodeName,
            IntermediateIdentity,
            IntermediateIdentityType = IntermediateIdentityLabel,
            FinalTarget = TargetAssetName,
            FinalTargetType = TargetAssetLabel,
            CriticalityTier = TargetCriticality,
            CriticalityTierLevel = TargetCriticalityLevel,
            TargetAssetCriticality = TargetCriticalityLevel,
            TargetAssetTier = TargetCriticality,
            EdgeLabel,
            CriticalityRuleBased = TargetCriticalityRuleBased,
            CriticalityRuleNames = TargetCriticalityRuleNames,
            IsCustomerFacing = TargetIsCustomerFacing,
            RiskProbability = TargetRiskProbability,
            SecuritySeverity = SecuritySeverityLevel,
            SecurityScore = SecuritySeverityScore,
            AttackPath =
                strcat(
                    FirstSourceDeviceLabel, " [", FirstSourceDeviceName, "] -> ",
                    CredentialNodeLabel, " -> ",
                    IntermediateIdentityLabel, " [", IntermediateIdentity, "] -> ",
                    TargetAssetLabel, " [", TargetAssetName, "]"
                ),
            AttackPathDetailed =
                strcat(
                    "SOURCE: ", FirstSourceDeviceLabel, " [", FirstSourceDeviceName, "] (", SourceDeviceCriticalityLevel, ") ",
                    iff(SourceDeviceCount > 1, strcat("+ ", SourceDeviceCount - 1, " other device(s)"), ""),
                    " -> ",
                    "CREDENTIAL: ", CredentialNodeLabel, " -> ",
                    "IDENTITY: ", IntermediateIdentityLabel, " [", IntermediateIdentity, "] -> ",
                    "TARGET: ", TargetAssetLabel, " [", TargetAssetName, "] (", TargetCriticalityLevel, ") | ",
                    LateralMovementType, " | ",
                    "Customer-Facing: ", iff(TargetIsCustomerFacing, "Yes", "No")
                )
        | order by SecurityScore desc, TierEscalation desc, TargetAssetTier asc

  - ReportName: Attack_Paths_Detailed_v2_Github_to_Azure_Resources
    ReportPurpose: Attack Paths - Github to Azure resources.  GitHub -> Secret -> Azure Resource. Key Detection -> Supply chain compromise
    SecurityDomain: SecurityDomain
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)),
                     LabelStr      = tolower(tostring(NodeLabel))
            | extend NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties.criticalityLevel.criticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", "),
                    ""
                )
            | extend EG_IsCustomerFacing =
                tobool(coalesce(
                    NodeProperties.rawData.isCustomerFacing,
                    NodeProperties.raw.isCustomerFacing,
                    false
                ))
            | extend EG_IsExcluded =
                tobool(coalesce(
                    NodeProperties.rawData.isExcluded,
                    NodeProperties.raw.isExcluded,
                    false
                ))
            | extend RiskFactors =
                todynamic(coalesce(
                    tostring(NodeProperties.rawData.risk.riskFactors),
                    tostring(NodeProperties.risk.riskFactors),
                    "[]"
                ))
            | extend RawCriticality =
                tostring(coalesce(
                    NodeProperties.rawData.criticality,
                    NodeProperties.criticality,
                    ""
                ))
            | extend RiskFactor_Probability =
                iff(
                    EG_IsCustomerFacing == true
                    or tolower(RawCriticality) in ("critical", "very high")
                    or tostring(RiskFactors) has "Exposure to the Internet",
                    1, 0
                )
            | extend IsEntryPoint =
                        (CategoriesStr has "ip_address")
                     or (CategoriesStr has "device")
                     or (CategoriesStr has "virtual_machine")
                     or (CategoriesStr has "computer"),
                     IsAzureResource =
                        (CategoriesStr has "environmentazure")
                     or (CategoriesStr has "environmentcloud")
            | extend CriticalityTier =
                case(
                    CriticalityLevel == 0, 0,
                    CriticalityLevel == 1, 1,
                    CriticalityLevel == 2, 2,
                    3
                )
            | extend CriticalityTierLevel =
                case(
                    CriticalityTier == 0, "Critical - tier 0",
                    CriticalityTier == 1, "High - tier 1",
                    CriticalityTier == 2, "Medium - tier 2",
                    "Low - tier 3"
                )
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityTier,
                CriticalityTierLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded,
                IsEntryPoint,
                IsAzureResource,
                RiskFactor_Probability,
                RawCriticality,
                RiskFactors;

        // Normalize labels to avoid "microsoft. sql" / "microsoft. compute" typos breaking filters
        let NormalizeLabel = (s:string) { tolower(trim(" ", replace_string(s, " ", ""))) };

        // Find credentials in GitHub workflows/repositories
        let GitHubCredentials =
            ExposureGraphEdges
            | where EdgeLabel in ("contains", "defined in")
            | extend SourceNodeLabelNorm = NormalizeLabel(SourceNodeLabel),
                     TargetNodeLabelNorm = NormalizeLabel(TargetNodeLabel)
            | where SourceNodeLabelNorm in ("githubworkflow", "githubrepository")
            | where TargetNodeLabelNorm in (
                "azure-active-directory-app-secret",
                "user-azure-cli-secret",
                "azure-storage-shared-access-signature",
                "azure-storage-connection-string",
                "azure-database-connection-string",
                "azure-active-directory-user-credentials",
                "service-principal-azure-cli-secret",
                "azure-app-configuration-key"
            )
            | project
                SourceGitHubNodeId    = SourceNodeId,
                SourceGitHubNodeName  = SourceNodeName,
                SourceGitHubNodeLabel = SourceNodeLabel,
                CredentialNodeId      = TargetNodeId,
                CredentialNodeName    = TargetNodeName,
                CredentialNodeLabel   = TargetNodeLabel
            | summarize
                GitHubSources         = make_set(SourceGitHubNodeName),
                GitHubSourceTypes     = make_set(SourceGitHubNodeLabel),
                GitHubSourceCount     = dcount(SourceGitHubNodeId),
                FirstGitHubSource     = any(SourceGitHubNodeId),
                FirstGitHubSourceName = any(SourceGitHubNodeName),
                FirstGitHubSourceLabel = any(SourceGitHubNodeLabel)
              by CredentialNodeId, CredentialNodeName, CredentialNodeLabel;

        // Main attack path query
        GitHubCredentials
        | join kind=inner (
            ExposureGraphEdges
            | where EdgeLabel in ("has credentials of", "can authenticate as", "can authenticate to")
        ) on $left.CredentialNodeId == $right.SourceNodeId
        | join kind=inner (
            ExposureGraphEdges
            | where EdgeLabel in ("can authenticate to", "has permissions to", "has role on")
            | extend TargetNodeLabelNorm = NormalizeLabel(TargetNodeLabel)
            | where TargetNodeLabelNorm in (
                "microsoft.compute/virtualmachines",
                "microsoft.storage/storageaccounts",
                "microsoft.keyvault/vaults",
                "microsoft.sql/servers",
                "microsoft.sql/servers/databases",
                "microsoft.cognitiveservices/accounts",
                "microsoft.cognitiveservices/accounts_openai",
                "subscriptions",
                "resourcegroups",
                "blobcontainer"
            )
        ) on $left.TargetNodeId == $right.SourceNodeId

        // Optional avoid “GitHub source” == “target asset” scenarios (usually not needed but safe)
        | where FirstGitHubSource != TargetNodeId1

        | summarize
            GitHubSources          = any(GitHubSources),
            GitHubSourceTypes      = any(GitHubSourceTypes),
            GitHubSourceCount      = any(GitHubSourceCount),
            FirstGitHubSource      = any(FirstGitHubSource),
            FirstGitHubSourceName  = any(FirstGitHubSourceName),
            FirstGitHubSourceLabel = any(FirstGitHubSourceLabel),
            CredentialNodeName     = any(CredentialNodeName),
            CredentialNodeLabel    = any(CredentialNodeLabel),
            IntermediateIdentity   = any(TargetNodeName),
            IntermediateIdentityLabel = any(TargetNodeLabel),
            EdgeLabel              = any(EdgeLabel1),
            TargetAsset            = any(TargetNodeId1),
            TargetAssetName        = any(TargetNodeName1),
            TargetAssetLabel       = any(TargetNodeLabel1)
          by CredentialNodeId, TargetNodeId1

        | join kind=leftouter (Nodes) on $left.FirstGitHubSource == $right.AssetNodeId
        | join kind=leftouter (Nodes) on $left.TargetAsset == $right.AssetNodeId

        | extend
            SourceIsCustomerFacing = true, // GitHub is internet-facing by default
            SourceCriticalityTier  = 3,    // GitHub workflow/repo is treated as low trust
            TargetCriticality      = CriticalityTier1,
            TargetCriticalityLevel = CriticalityTierLevel1,
            TargetIsCustomerFacing = EG_IsCustomerFacing1,
            TargetCriticalityRuleBased = CriticalityRuleBased1,
            TargetCriticalityRuleNames = CriticalityRuleNames1,
            TargetRiskProbability  = RiskFactor_Probability1

        | extend TierEscalation =
            case(
                SourceCriticalityTier > TargetCriticality, SourceCriticalityTier - TargetCriticality,
                0
            )

        | extend SecuritySeverityScore =
            case(
                TierEscalation >= 3 and TargetCriticality == 0, 10,
                TierEscalation >= 2 and TargetCriticality == 0, 9,
                TierEscalation >= 1 and TargetCriticality == 0, 8,
                TierEscalation >= 2 and TargetCriticality == 1, 8,
                TierEscalation >= 1 and TargetCriticality == 1, 7,
                TargetCriticality == 0, 7,
                TargetCriticality == 1, 6,
                TargetCriticality == 2, 4,
                2
            )
        | extend SecuritySeverityLevel =
            case(
                SecuritySeverityScore >= 9, "Critical",
                SecuritySeverityScore >= 7, "Very High",
                SecuritySeverityScore >= 5, "High",
                SecuritySeverityScore >= 3, "Medium-High",
                "Medium"
            )

        | extend SecurityDomain = "Supply Chain"
        | extend Category = "AttackPath_GitHubToAzure"
        | extend Subcategory =
            case(
                TierEscalation >= 3, strcat("GitHub to Tier ", TargetCriticality, " - Critical Supply Chain Risk"),
                TierEscalation >= 2, strcat("GitHub to Tier ", TargetCriticality, " - High Supply Chain Risk"),
                TierEscalation >= 1, strcat("GitHub to Tier ", TargetCriticality, " - Moderate Supply Chain Risk"),
                "GitHub to Azure - Direct Access"
            )

        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName  = IntermediateIdentity,
            AssetLabel = IntermediateIdentityLabel,
            ConfigurationName = FirstGitHubSourceName,
            ConfigurationId   = CredentialNodeLabel,
            TierEscalation,
            SourceGitHub = FirstGitHubSourceName,
            SourceGitHubType = FirstGitHubSourceLabel,
            TotalGitHubSourcesWithCredential = GitHubSourceCount,
            AllGitHubSources = GitHubSources,
            CredentialType = CredentialNodeLabel,
            CredentialNode = CredentialNodeName,
            IntermediateIdentity,
            IntermediateIdentityType = IntermediateIdentityLabel,
            FinalTarget = TargetAssetName,
            FinalTargetType = TargetAssetLabel,
            CriticalityTier = TargetCriticality,
            CriticalityTierLevel = TargetCriticalityLevel,
            EdgeLabel,
            CriticalityRuleBased = TargetCriticalityRuleBased,
            CriticalityRuleNames = TargetCriticalityRuleNames,
            IsCustomerFacing = TargetIsCustomerFacing,
            RiskProbability = TargetRiskProbability,
            SecuritySeverity = SecuritySeverityLevel,
            SecurityScore = SecuritySeverityScore,
            AttackPath =
                strcat(
                    FirstGitHubSourceLabel, " [", FirstGitHubSourceName, "] -> ",
                    CredentialNodeLabel, " -> ",
                    IntermediateIdentityLabel, " [", IntermediateIdentity, "] -> ",
                    TargetAssetLabel, " [", TargetAssetName, "]"
                ),
            AttackPathDetailed =
                strcat(
                    "SOURCE: ", FirstGitHubSourceLabel, " [", FirstGitHubSourceName, "] (Internet-Facing) ",
                    iff(GitHubSourceCount > 1, strcat("+ ", GitHubSourceCount - 1, " other GitHub source(s)"), ""),
                    " -> ",
                    "CREDENTIAL: ", CredentialNodeLabel, " -> ",
                    "IDENTITY: ", IntermediateIdentityLabel, " [", IntermediateIdentity, "] -> ",
                    "TARGET: ", TargetAssetLabel, " [", TargetAssetName, "] (", TargetCriticalityLevel, ")"
                )
        | order by SecurityScore desc, TierEscalation desc, CriticalityTier asc

  - ReportName: Attack_Paths_Detailed_v2_Public_IP_to_VM_with_CVE_Exploitation
    ReportPurpose: Attack Paths with focus on Public IP to VM with CVE Exploitation. Public IP -> Vulnerable VM/Device. Key detection -> Internet-exposed vulnerabilities
    SecurityDomain: SecurityDomain
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)),
                     LabelStr      = tolower(tostring(NodeLabel))
            | extend NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties.criticalityLevel.criticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", "),
                    ""
                )
            | extend EG_IsCustomerFacing =
                tobool(coalesce(
                    NodeProperties.rawData.isCustomerFacing,
                    NodeProperties.raw.isCustomerFacing,
                    false
                ))
            | extend EG_IsExcluded =
                tobool(coalesce(
                    NodeProperties.rawData.isExcluded,
                    NodeProperties.raw.isExcluded,
                    false
                ))
            | extend RiskFactors =
                todynamic(coalesce(
                    tostring(NodeProperties.rawData.risk.riskFactors),
                    tostring(NodeProperties.risk.riskFactors),
                    "[]"
                ))
            | extend RawCriticality =
                tostring(coalesce(
                    NodeProperties.rawData.criticality,
                    NodeProperties.criticality,
                    ""
                ))
            | extend RiskFactor_Probability =
                iff(
                    EG_IsCustomerFacing == true
                    or tolower(RawCriticality) in ("critical", "very high")
                    or tostring(RiskFactors) has "Exposure to the Internet",
                    1, 0
                )
            | extend CVESeverity =
                tostring(coalesce(
                    NodeProperties.rawData.severity,
                    NodeProperties.rawData.Severity,
                    NodeProperties.rawData.cvssScore,
                    ""
                ))
            | extend IsEntryPoint =
                        (CategoriesStr has "ip_address")
                     or (CategoriesStr has "device")
                     or (CategoriesStr has "virtual_machine")
                     or (CategoriesStr has "computer"),
                     IsAzureResource =
                        (CategoriesStr has "environmentazure")
                     or (CategoriesStr has "environmentcloud")
            | extend CriticalityTier =
                case(
                    CriticalityLevel == 0, 0,
                    CriticalityLevel == 1, 1,
                    CriticalityLevel == 2, 2,
                    3
                )
            | extend CriticalityTierLevel =
                case(
                    CriticalityTier == 0, "Critical - tier 0",
                    CriticalityTier == 1, "High - tier 1",
                    CriticalityTier == 2, "Medium - tier 2",
                    "Low - tier 3"
                )
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityTier,
                CriticalityTierLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded,
                IsEntryPoint,
                IsAzureResource,
                RiskFactor_Probability,
                RawCriticality,
                RiskFactors,
                CVESeverity;

        // Helper to avoid label typos like "microsoft. compute/..." or spaces
        let NormalizeLabel = (s:string) { tolower(trim(" ", replace_string(s, " ", ""))) };

        // Find Public IPs connected to resources
        let PublicIPConnections =
            ExposureGraphEdges
            | where SourceNodeLabel == "microsoft.network/publicipaddresses"
            | where EdgeLabel in ("routes traffic to", "contains")
            | extend TargetNodeLabelNorm = NormalizeLabel(TargetNodeLabel)
            | where TargetNodeLabelNorm in (
                "microsoft.network/networkinterfaces",
                "microsoft.compute/virtualmachines",
                "device"
            )
            | project
                PublicIPNodeId            = SourceNodeId,
                PublicIPNodeName          = SourceNodeName,
                ExposedResourceNodeId     = TargetNodeId,
                ExposedResourceNodeName   = TargetNodeName,
                ExposedResourceNodeLabel  = TargetNodeLabel
            | summarize
                PublicIPs         = make_set(PublicIPNodeName),
                PublicIPCount     = dcount(PublicIPNodeId),
                FirstPublicIP     = any(PublicIPNodeId),
                FirstPublicIPName = any(PublicIPNodeName)
              by ExposedResourceNodeId, ExposedResourceNodeName, ExposedResourceNodeLabel;

        // Find CVEs affecting resources
        let CVEsAffectingResources =
            ExposureGraphEdges
            | where SourceNodeLabel == "Cve"
            | where EdgeLabel == "affecting"
            | extend TargetNodeLabelNorm = NormalizeLabel(TargetNodeLabel)
            | where TargetNodeLabelNorm in (
                "microsoft.compute/virtualmachines",
                "device",
                "computer-account"
            )
            | project
                CVENodeId                = SourceNodeId,
                CVENodeName              = SourceNodeName,
                AffectedResourceNodeId   = TargetNodeId,
                AffectedResourceNodeName = TargetNodeName,
                AffectedResourceNodeLabel = TargetNodeLabel
            | summarize
                CVEs         = make_set(CVENodeName),
                CVECount     = dcount(CVENodeId),
                FirstCVE     = any(CVENodeId),
                FirstCVEName = any(CVENodeName)
              by AffectedResourceNodeId, AffectedResourceNodeName, AffectedResourceNodeLabel;

        // Join Public IPs with CVEs
        PublicIPConnections
        | join kind=inner CVEsAffectingResources on $left.ExposedResourceNodeId == $right.AffectedResourceNodeId
        | summarize
            PublicIPs         = any(PublicIPs),
            PublicIPCount     = any(PublicIPCount),
            FirstPublicIPName = any(FirstPublicIPName),
            CVEs              = any(CVEs),
            CVECount          = any(CVECount),
            FirstCVEName      = any(FirstCVEName),
            FirstCVE          = any(FirstCVE)
          by ExposedResourceNodeId, ExposedResourceNodeName, ExposedResourceNodeLabel

        // Enrich exposed resource (target asset) info
        | join kind=leftouter (Nodes) on $left.ExposedResourceNodeId == $right.AssetNodeId

        // Enrich CVE node info (for severity)
        | join kind=leftouter (Nodes) on $left.FirstCVE == $right.AssetNodeId

        | extend
            TargetCriticality          = CriticalityTier,          // from exposed resource join
            TargetCriticalityLevel     = CriticalityTierLevel,
            TargetIsCustomerFacing     = EG_IsCustomerFacing,
            TargetCriticalityRuleBased = CriticalityRuleBased,
            TargetCriticalityRuleNames = CriticalityRuleNames,
            TargetRiskProbability      = RiskFactor_Probability,
            CVESev                     = CVESeverity1              // from CVE join

        | extend CVESeverityScore =
            case(
                tolower(CVESev) has "critical", 5,
                tolower(CVESev) has "high", 4,
                tolower(CVESev) has "medium", 3,
                tolower(CVESev) has "low", 2,
                1
            )

        | extend SecuritySeverityScore =
            case(
                TargetCriticality == 0 and CVESeverityScore >= 4, 10,
                TargetCriticality == 0 and CVESeverityScore >= 3, 9,
                TargetCriticality == 1 and CVESeverityScore >= 4, 8,
                TargetCriticality == 1 and CVESeverityScore >= 3, 7,
                TargetCriticality == 2 and CVESeverityScore >= 4, 6,
                CVESeverityScore >= 4, 5,
                CVESeverityScore >= 3, 4,
                3
            )

        | extend SecuritySeverityLevel =
            case(
                SecuritySeverityScore >= 9, "Critical",
                SecuritySeverityScore >= 7, "Very High",
                SecuritySeverityScore >= 5, "High",
                SecuritySeverityScore >= 3, "Medium-High",
                "Medium"
            )

        | extend SecurityDomain = "Internet-Exposed Assets"
        | extend Category = "AttackPath_PublicIPWithCVE"
        | extend Subcategory =
            case(
                TargetCriticality == 0 and CVESeverityScore >= 4, "Tier 0 - Internet-Exposed with Critical CVE",
                TargetCriticality == 0, "Tier 0 - Internet-Exposed with Vulnerability",
                TargetCriticality == 1 and CVESeverityScore >= 4, "Tier 1 - Internet-Exposed with Critical CVE",
                TargetCriticality == 1, "Tier 1 - Internet-Exposed with Vulnerability",
                CVESeverityScore >= 4, "Internet-Exposed with Critical CVE",
                "Internet-Exposed with Vulnerability"
            )

        | order by SecuritySeverityScore desc, TargetCriticality asc, CVESeverityScore desc

        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName = ExposedResourceNodeName,
            AssetLabel = ExposedResourceNodeLabel,
            ConfigurationName = FirstPublicIPName,
            ConfigurationId = FirstCVEName,
            PublicIPAddress = FirstPublicIPName,
            TotalPublicIPs = PublicIPCount,
            AllPublicIPs = PublicIPs,
            CVE = FirstCVEName,
            TotalCVEs = CVECount,
            AllCVEs = CVEs,
            CVESeverity = CVESev,
            ExposedResource = ExposedResourceNodeName,
            ExposedResourceType = ExposedResourceNodeLabel,
            CriticalityTier = TargetCriticality,
            CriticalityTierLevel = TargetCriticalityLevel,
            CriticalityRuleBased = TargetCriticalityRuleBased,
            CriticalityRuleNames = TargetCriticalityRuleNames,
            IsCustomerFacing = TargetIsCustomerFacing,
            RiskProbability = TargetRiskProbability,
            SecuritySeverity = SecuritySeverityLevel,
            SecurityScore = SecuritySeverityScore,
            AttackPath =
                strcat(
                    "Public IP [", FirstPublicIPName, "] -> ",
                    ExposedResourceNodeLabel, " [", ExposedResourceNodeName, "] <- ",
                    "CVE [", FirstCVEName, "]"
                ),
            AttackPathDetailed =
                strcat(
                    "PUBLIC IP: [", FirstPublicIPName, "] ",
                    iff(PublicIPCount > 1, strcat("+ ", PublicIPCount - 1, " other IP(s)"), ""),
                    " -> ",
                    "EXPOSED: ", ExposedResourceNodeLabel, " [", ExposedResourceNodeName, "] (", TargetCriticalityLevel, ") <- ",
                    "CVE: [", FirstCVEName, "] (", CVESev, ") ",
                    iff(CVECount > 1, strcat("+ ", CVECount - 1, " other CVE(s)"), "")
                );

  - ReportName: Attack_Paths_Detailed_v2_Identity_Group_Membership_to_Privileged_Resources
    ReportPurpose: Attack Paths based on Identity Group Membership to Privileged Resources. Identity -> Group -> Privileged Resource. Key Detection -> Group-based attacks
    SecurityDomain: SecurityDomain
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)), 
                     LabelStr = tolower(tostring(NodeLabel))
            | extend NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties. criticalityLevel.criticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties. criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties. criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", "),
                    ""
                )
            | extend EG_IsCustomerFacing = tobool(coalesce(
                NodeProperties. rawData.isCustomerFacing,
                NodeProperties.raw. isCustomerFacing,
                false
              ))
            | extend EG_IsExcluded = tobool(coalesce(
                NodeProperties.rawData.isExcluded,
                NodeProperties. raw.isExcluded,
                false
              ))
            | extend RiskFactors = todynamic(coalesce(
                tostring(NodeProperties.rawData.risk.riskFactors),
                tostring(NodeProperties.risk.riskFactors),
                "[]"
              ))
            | extend RawCriticality = tostring(coalesce(
                NodeProperties.rawData.criticality,
                NodeProperties.criticality,
                ""
              ))
            | extend RiskFactor_Probability =
                iff(
                    EG_IsCustomerFacing == true
                    or tolower(RawCriticality) in ("critical","very high")
                    or tostring(RiskFactors) has "Exposure to the Internet",
                    1, 0
                )
            | extend IsEntryPoint = (CategoriesStr has "ip_address") or 
                                   (CategoriesStr has "device") or 
                                   (CategoriesStr has "virtual_machine") or 
                                   (CategoriesStr has "computer"),
                     IsAzureResource = (CategoriesStr has "environmentazure") or 
                                      (CategoriesStr has "environmentcloud")
            | extend CriticalityTier = case(
                    CriticalityLevel == 0, 0,
                    CriticalityLevel == 1, 1,
                    CriticalityLevel == 2, 2,
                    3
                )
            | extend CriticalityTierLevel = case(
                    CriticalityTier == 0, "Critical - tier 0",
                    CriticalityTier == 1, "High - tier 1",
                    CriticalityTier == 2, "Medium - tier 2",
                    "Low - tier 3"
                )
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityTier,
                CriticalityTierLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded,
                IsEntryPoint,
                IsAzureResource,
                RiskFactor_Probability,
                RawCriticality,
                RiskFactors;
        // Find identities in groups
        let IdentityGroupMembership = 
            ExposureGraphEdges
            | where EdgeLabel == "member of"
            | where SourceNodeLabel in ("user", "serviceprincipal", "managedidentity")
            | where TargetNodeLabel == "group"
            | project IdentityNodeId = SourceNodeId,
                      IdentityNodeName = SourceNodeName,
                      IdentityNodeLabel = SourceNodeLabel,
                      GroupNodeId = TargetNodeId,
                      GroupNodeName = TargetNodeName
            | summarize 
                Identities = make_set(IdentityNodeName),
                IdentityTypes = make_set(IdentityNodeLabel),
                IdentityCount = dcount(IdentityNodeId),
                FirstIdentity = any(IdentityNodeId),
                FirstIdentityName = any(IdentityNodeName),
                FirstIdentityLabel = any(IdentityNodeLabel)
              by GroupNodeId, GroupNodeName;
        // Main attack path query
        IdentityGroupMembership
        | join kind=inner (
            ExposureGraphEdges
            | where EdgeLabel in ("has role on", "has permissions to")
            | where TargetNodeLabel in (
                "subscriptions",
                "resourcegroups",
                "microsoft.keyvault/vaults",
                "microsoft.storage/storageaccounts",
                "microsoft.sql/servers",
                "microsoft.compute/virtualmachines",
                "microsoft.cognitiveservices/accounts"
            )
        ) on $left.GroupNodeId == $right.SourceNodeId
        | summarize 
            Identities = any(Identities),
            IdentityTypes = any(IdentityTypes),
            IdentityCount = any(IdentityCount),
            FirstIdentity = any(FirstIdentity),
            FirstIdentityName = any(FirstIdentityName),
            FirstIdentityLabel = any(FirstIdentityLabel),
            GroupNodeName = any(GroupNodeName),
            EdgeLabel = any(EdgeLabel),
            TargetAsset = any(TargetNodeId),
            TargetAssetName = any(TargetNodeName),
            TargetAssetLabel = any(TargetNodeLabel)
          by GroupNodeId, TargetNodeId
        | join kind=leftouter (Nodes) on $left.FirstIdentity == $right.AssetNodeId
        | join kind=leftouter (Nodes) on $left.TargetAsset == $right. AssetNodeId
        | extend SourceCriticality = CriticalityTier,
                 SourceCriticalityLevel = CriticalityTierLevel,
                 SourceIsCustomerFacing = EG_IsCustomerFacing,
                 TargetCriticality = CriticalityTier1,
                 TargetCriticalityLevel = CriticalityTierLevel1,
                 TargetIsCustomerFacing = EG_IsCustomerFacing1,
                 TargetCriticalityRuleBased = CriticalityRuleBased1,
                 TargetCriticalityRuleNames = CriticalityRuleNames1,
                 TargetRiskProbability = RiskFactor_Probability1
        | extend TierEscalation = case(
                SourceCriticality > TargetCriticality, SourceCriticality - TargetCriticality,
                0
            )
        | extend SecuritySeverityScore = case(
                TierEscalation >= 3 and TargetCriticality == 0, 9,
                TierEscalation >= 2 and TargetCriticality == 0, 8,
                TierEscalation >= 1 and TargetCriticality == 0, 7,
                TargetCriticality == 0, 7,
                TierEscalation >= 2 and TargetCriticality == 1, 6,
                TierEscalation >= 1 and TargetCriticality == 1, 5,
                TargetCriticality == 1, 5,
                TargetCriticality == 2, 3,
                2
            )
        | extend SecuritySeverityLevel = case(
                SecuritySeverityScore >= 8, "Critical",
                SecuritySeverityScore >= 6, "Very High",
                SecuritySeverityScore >= 4, "High",
                SecuritySeverityScore >= 2, "Medium-High",
                "Medium"
            )
        | extend SecurityDomain = "Azure"
        | extend Category = "AttackPath_GroupMembershipPrivilege"
        | extend Subcategory = case(
                TierEscalation >= 3, strcat("Tier ", SourceCriticality, " to Tier ", TargetCriticality, " - Group-Based Privilege Escalation"),
                TierEscalation >= 2, strcat("Tier ", SourceCriticality, " to Tier ", TargetCriticality, " - Group-Based Escalation"),
                TierEscalation >= 1, strcat("Tier ", SourceCriticality, " to Tier ", TargetCriticality, " - Group Privilege"),
                "Group-Based Access to Privileged Resource"
            )
        | project 
            SecurityDomain,
            Category,
            Subcategory,
            AssetName = GroupNodeName,
            AssetLabel = "group",
            ConfigurationName = FirstIdentityName,
            ConfigurationId = FirstIdentityLabel,
            TierEscalation,
            SourceIdentity = FirstIdentityName,
            SourceIdentityType = FirstIdentityLabel,
            SourceIdentityCriticality = SourceCriticalityLevel,
            TotalIdentitiesInGroup = IdentityCount,
            AllIdentities = Identities,
            GroupName = GroupNodeName,
            EdgeLabel,
            FinalTarget = TargetAssetName,
            FinalTargetType = TargetAssetLabel,
            CriticalityTier = TargetCriticality,
            CriticalityTierLevel = TargetCriticalityLevel,
            CriticalityRuleBased = TargetCriticalityRuleBased,
            CriticalityRuleNames = TargetCriticalityRuleNames,
            IsCustomerFacing = TargetIsCustomerFacing,
            RiskProbability = TargetRiskProbability,
            SecuritySeverity = SecuritySeverityLevel,
            SecurityScore = SecuritySeverityScore,
            AttackPath = strcat(
                FirstIdentityLabel, " [", FirstIdentityName, "] -> ",
                "Group [", GroupNodeName, "] -> ",
                TargetAssetLabel, " [", TargetAssetName, "]"
            ),
            AttackPathDetailed = strcat(
                "IDENTITY: ", FirstIdentityLabel, " [", FirstIdentityName, "] (", SourceCriticalityLevel, ") ",
                iff(IdentityCount > 1, strcat("+ ", IdentityCount - 1, " other identity/ies"), ""), " -> ",
                "GROUP: [", GroupNodeName, "] -> ",
                "TARGET: ", TargetAssetLabel, " [", TargetAssetName, "] (", TargetCriticalityLevel, ")"
            )
        | order by SecurityScore desc, TierEscalation desc, CriticalityTier asc

  - ReportName: Attack_Paths_Detailed_v2_Data_Sensitivity_to_Exposed_Credentials
    ReportPurpose: Attack Paths with Data Sensitivity to Exposed Credentials. Sensitive Data -> Storage -> Exposed Credential. Key detection -> Data exfiltration risk
    SecurityDomain: SecurityDomain
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)),
                     LabelStr      = tolower(tostring(NodeLabel))
            | extend NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties.criticalityLevel.criticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", "),
                    ""
                )
            | extend EG_IsCustomerFacing =
                tobool(coalesce(
                    NodeProperties.rawData.isCustomerFacing,
                    NodeProperties.raw.isCustomerFacing,
                    false
                ))
            | extend EG_IsExcluded =
                tobool(coalesce(
                    NodeProperties.rawData.isExcluded,
                    NodeProperties.raw.isExcluded,
                    false
                ))
            | extend RiskFactors =
                todynamic(coalesce(
                    tostring(NodeProperties.rawData.risk.riskFactors),
                    tostring(NodeProperties.risk.riskFactors),
                    "[]"
                ))
            | extend RawCriticality =
                tostring(coalesce(
                    NodeProperties.rawData.criticality,
                    NodeProperties.criticality,
                    ""
                ))
            | extend RiskFactor_Probability =
                iff(
                    EG_IsCustomerFacing == true
                    or tolower(RawCriticality) in ("critical", "very high")
                    or tostring(RiskFactors) has "Exposure to the Internet",
                    1, 0
                )
            | extend CriticalityTier =
                case(
                    CriticalityLevel == 0, 0,
                    CriticalityLevel == 1, 1,
                    CriticalityLevel == 2, 2,
                    3
                )
            | extend CriticalityTierLevel =
                case(
                    CriticalityTier == 0, "Critical - tier 0",
                    CriticalityTier == 1, "High - tier 1",
                    CriticalityTier == 2, "Medium - tier 2",
                    "Low - tier 3"
                )
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityTier,
                CriticalityTierLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded,
                RiskFactor_Probability;

        let NormalizeLabel = (s:string) { tolower(trim(' ', replace_string(s, " ", ""))) };

        // Data location allowlist (normalized)
        let DataLocationLabels =
            dynamic([
                "blobcontainer",
                "microsoft.storage/storageaccounts",
                "microsoft.sql/servers/databases",
                "microsoft.sql/servers",
                "microsoft.storage/storageaccounts/blobservices/containers",
                "microsoft.storage/storageaccounts/fileservices/shares"
            ]);

        // Credential allowlist (normalized)
        let CredentialLabels =
            dynamic([
                "azure-storage-shared-access-signature",
                "azure-storage-connection-string",
                "azure-database-connection-string",
                "azure-active-directory-app-secret",
                "service-principal-azure-cli-secret",
                "user-azure-cli-secret",
                "azure-active-directory-user-credentials",
                "entra-usercookie"
            ]);

        // Find sensitive data locations
        let SensitiveDataLocations =
            ExposureGraphEdges
            | extend TargetNodeLabelNorm = NormalizeLabel(TargetNodeLabel)
            | where SourceNodeLabel == "dataSensitivityScan"
            | where EdgeLabel in ("defined in", "contains")
            | where TargetNodeLabelNorm in (DataLocationLabels)
            | project
                SensitiveDataNodeId   = SourceNodeId,
                SensitiveDataNodeName = SourceNodeName,
                DataLocationNodeId    = TargetNodeId,
                DataLocationNodeName  = TargetNodeName,
                DataLocationNodeLabel = TargetNodeLabel;

        // Identity -> data location access edges (broadened)
        let IdentityAccessToData =
            ExposureGraphEdges
            | extend TargetNodeLabelNorm = NormalizeLabel(TargetNodeLabel)
            | where EdgeLabel in ("has permissions to", "has role on", "can authenticate to", "has access to", "can access")
            | where TargetNodeLabelNorm in (DataLocationLabels)
            | project
                IdentityNodeId    = SourceNodeId,
                IdentityNodeName  = SourceNodeName,
                IdentityNodeLabel = SourceNodeLabel,
                DataLocationNodeId = TargetNodeId;

        // Credential exposure edges (support both directions)
        let ExposedCredentialsToIdentity =
            ExposureGraphEdges
            | where EdgeLabel in ("has credentials of", "can authenticate as", "can authenticate to")
            | project
                CredentialNodeId    = SourceNodeId,
                CredentialNodeName  = SourceNodeName,
                CredentialNodeLabel = SourceNodeLabel,
                IdentityNodeId      = TargetNodeId;

        let IdentityToExposedCredentials =
            ExposureGraphEdges
            | where EdgeLabel in ("has credentials of", "uses credential", "uses credentials", "authenticated by")
            | project
                IdentityNodeId      = SourceNodeId,
                CredentialNodeId    = TargetNodeId,
                CredentialNodeName  = TargetNodeName,
                CredentialNodeLabel = TargetNodeLabel;

        // Union both forms and then filter credential types
        let ExposedCreds =
            union isfuzzy=true ExposedCredentialsToIdentity, IdentityToExposedCredentials
            | extend CredentialNodeLabelNorm = NormalizeLabel(CredentialNodeLabel)
            | where CredentialNodeLabelNorm in (CredentialLabels);

        // Build the attack path sensitive data -> data location <- identity <- exposed credential
        IdentityAccessToData
        | join kind=inner SensitiveDataLocations on DataLocationNodeId
        | join kind=inner ExposedCreds on IdentityNodeId
        | summarize
            SensitiveDataItems        = make_set(SensitiveDataNodeName),
            SensitiveDataCount        = dcount(SensitiveDataNodeId),
            ExposedCredentials        = make_set(CredentialNodeName),
            ExposedCredentialTypes    = make_set(CredentialNodeLabel),
            ExposedCredentialCount    = dcount(CredentialNodeId),
            FirstCredentialName       = any(CredentialNodeName),
            FirstCredentialLabel      = any(CredentialNodeLabel),
            IdentityName              = any(IdentityNodeName),
            IdentityLabel             = any(IdentityNodeLabel)
          by DataLocationNodeId, DataLocationNodeName, DataLocationNodeLabel
        | join kind=leftouter (Nodes) on $left.DataLocationNodeId == $right.AssetNodeId
        | extend
            TargetCriticality         = CriticalityTier,
            TargetCriticalityLevel    = CriticalityTierLevel,
            TargetIsCustomerFacing    = EG_IsCustomerFacing,
            TargetCriticalityRuleBased = CriticalityRuleBased,
            TargetCriticalityRuleNames = CriticalityRuleNames,
            TargetRiskProbability     = RiskFactor_Probability
        | extend SecuritySeverityScore =
            case(
                ExposedCredentialCount >= 3 and TargetCriticality == 0, 10,
                ExposedCredentialCount >= 2 and TargetCriticality == 0, 9,
                ExposedCredentialCount >= 1 and TargetCriticality == 0, 8,
                ExposedCredentialCount >= 3 and TargetCriticality == 1, 8,
                ExposedCredentialCount >= 2 and TargetCriticality == 1, 7,
                ExposedCredentialCount >= 1 and TargetCriticality == 1, 6,
                ExposedCredentialCount >= 2, 5,
                4
            )
        | extend SecuritySeverityLevel =
            case(
                SecuritySeverityScore >= 9, "Critical",
                SecuritySeverityScore >= 7, "Very High",
                SecuritySeverityScore >= 5, "High",
                SecuritySeverityScore >= 3, "Medium-High",
                "Medium"
            )
        | extend SecurityDomain = "Data Protection"
        | extend Category = "AttackPath_SensitiveDataExposure"
        | extend Subcategory =
            case(
                ExposedCredentialCount >= 3 and TargetCriticality <= 1, "Critical Data - Multiple Exposed Credentials",
                ExposedCredentialCount >= 2 and TargetCriticality <= 1, "Critical Data - Exposed Credentials",
                ExposedCredentialCount >= 1 and TargetCriticality <= 1, "Critical Data - Single Exposed Credential",
                ExposedCredentialCount >= 2, "Sensitive Data - Multiple Exposed Credentials",
                "Sensitive Data - Exposed Credential"
            )
        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName = DataLocationNodeName,
            AssetLabel = DataLocationNodeLabel,
            ConfigurationName = FirstCredentialName,
            ConfigurationId = FirstCredentialLabel,
            SensitiveDataLocation = DataLocationNodeName,
            SensitiveDataLocationType = DataLocationNodeLabel,
            TotalSensitiveDataItems = SensitiveDataCount,
            AllSensitiveDataItems = SensitiveDataItems,
            ExposedCredential = FirstCredentialName,
            ExposedCredentialType = FirstCredentialLabel,
            TotalExposedCredentials = ExposedCredentialCount,
            AllExposedCredentials = ExposedCredentials,
            IdentityWithAccess = IdentityName,
            IdentityType = IdentityLabel,
            CriticalityTier = TargetCriticality,
            CriticalityTierLevel = TargetCriticalityLevel,
            CriticalityRuleBased = TargetCriticalityRuleBased,
            CriticalityRuleNames = TargetCriticalityRuleNames,
            IsCustomerFacing = TargetIsCustomerFacing,
            RiskProbability = TargetRiskProbability,
            SecuritySeverity = SecuritySeverityLevel,
            SecurityScore = SecuritySeverityScore,
            AttackPath =
                strcat(
                    "Sensitive Data -> ",
                    DataLocationNodeLabel, " [", DataLocationNodeName, "] <- ",
                    "Identity [", IdentityName, "] <- ",
                    FirstCredentialLabel, " [", FirstCredentialName, "]"
                ),
            AttackPathDetailed =
                strcat(
                    "SENSITIVE DATA: ", SensitiveDataCount, " item(s) in ",
                    DataLocationNodeLabel, " [", DataLocationNodeName, "] (", TargetCriticalityLevel, ") <- ",
                    "IDENTITY: [", IdentityName, "] <- ",
                    "EXPOSED CREDENTIAL: ", FirstCredentialLabel, " [", FirstCredentialName, "] ",
                    iff(ExposedCredentialCount > 1, strcat("+ ", ExposedCredentialCount - 1, " other credential(s)"), "")
                )
        | order by SecurityScore desc, CriticalityTier asc, TotalExposedCredentials desc

  - ReportName: Attack_Paths_Detailed_v2_Device_with_high_severity_vulnerabilities_allows_lateral_movement_Azure 
    ReportPurpose: Attack Paths with Device with high severity vulnerabilities allows lateral movement
    SecurityDomain: SecurityDomain
    CategoryInputName: Category
    SubcategoryInputName: Subcategory
    ConfigurationIdInputName: ConfigurationId
    SecuritySeverityInputName: SecuritySeverity
    CriticalityTierLevelInputName: CriticalityTierLevel
    RiskConsequenceScoreOutputName: RiskConsequenceScore
    RiskProbabilityScoreOutputName: RiskProbablityScore
    RiskScoreOutputName: RiskScoreTotal
    CriticalityTierLevelScope:
      - "Critical - tier 0"
      - "High - tier 1"
      - "Medium - tier 2"
      - "Low - tier 3"
    SecuritySeverityScope:
      - "Very High"
      - "High"
      - "Medium-High"
      - "Medium"
      - "Low"
    OutputPropertyOrder:
      - "SecurityDomain"
      - "Category"
      - "Subcategory"
      - "AssetName"
      - "AssetLabel"
      - "ConfigurationName"
      - "ConfigurationId"
      - "Impact"
      - "SecuritySeverity"
      - "CriticalityTier"
      - "CriticalityTierLevel"
      - "RiskFactor_Consequence"
      - "RiskFactor_Probability"
      - "RiskConsequenceScore"
      - "RiskProbablityScore"
      - "RiskScoreTotal"
    SortBy:
      - "RiskScoreTotal"
    ReportQuery:
      - |
        let Nodes =
            ExposureGraphNodes
            | extend CategoriesStr = tolower(tostring(Categories)),
                     LabelStr      = tolower(tostring(NodeLabel))
            | extend NodeNameNorm = coalesce(NodeName, tostring(EntityIds[0].id), tostring(NodeId))
            | extend CriticalityLevel =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].criticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.criticalityLevel),
                    tostring(NodeProperties.criticalityLevel.criticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleBased =
                toint(coalesce(
                    tostring(NodeProperties.criticalityLevelProps[0].ruleBasedCriticalityLevel),
                    tostring(NodeProperties.rawData.criticalityLevel.ruleBasedCriticalityLevel),
                    tostring(NodeProperties.criticalityLevel.ruleBasedCriticalityLevel),
                    "999"
                ))
            | extend CriticalityRuleNames =
                coalesce(
                    strcat_array(NodeProperties.criticalityLevelProps[0].ruleNames, ", "),
                    strcat_array(NodeProperties.rawData.criticalityLevel.ruleNames, ", "),
                    ""
                )
            | extend EG_IsCustomerFacing =
                tobool(coalesce(
                    NodeProperties.rawData.isCustomerFacing,
                    NodeProperties.raw.isCustomerFacing,
                    false
                ))
            | extend EG_IsExcluded =
                tobool(coalesce(
                    NodeProperties.rawData.isExcluded,
                    NodeProperties.raw.isExcluded,
                    false
                ))
            | extend RiskFactors =
                todynamic(coalesce(
                    tostring(NodeProperties.rawData.risk.riskFactors),
                    tostring(NodeProperties.risk.riskFactors),
                    "[]"
                ))
            | extend RawCriticality =
                tostring(coalesce(
                    NodeProperties.rawData.criticality,
                    NodeProperties.criticality,
                    ""
                ))
            | extend CVESeverity =
                tostring(coalesce(
                    NodeProperties.rawData.severity,
                    NodeProperties.rawData.Severity,
                    NodeProperties.rawData.cvssScore,
                    ""
                ))
            | extend RiskFactor_Probability =
                iff(
                    EG_IsCustomerFacing == true
                    or tolower(RawCriticality) in ("critical", "very high")
                    or tostring(RiskFactors) has "Exposure to the Internet",
                    1, 0
                )
            | extend IsEntryPoint =
                        (CategoriesStr has "ip_address")
                     or (CategoriesStr has "device")
                     or (CategoriesStr has "virtual_machine")
                     or (CategoriesStr has "computer"),
                     IsAzureResource =
                        (CategoriesStr has "environmentazure")
                     or (CategoriesStr has "environmentcloud")
            // Tier mapping (per your definition)
            | extend CriticalityTier =
                case(
                    CriticalityLevel == 0, 0,
                    CriticalityLevel == 1, 1,
                    CriticalityLevel == 2, 2,
                    3
                )
            | extend CriticalityTierLevel =
                case(
                    CriticalityTier == 0, "Critical - tier 0",
                    CriticalityTier == 1, "High - tier 1",
                    CriticalityTier == 2, "Medium - tier 2",
                    "Low - tier 3"
                )
            | project
                AssetNodeId = NodeId,
                AssetName   = NodeName,
                AssetLabel  = NodeLabel,
                AssetProps  = NodeProperties,
                CriticalityLevel,
                CriticalityTier,
                CriticalityTierLevel,
                CriticalityRuleBased,
                CriticalityRuleNames,
                EG_IsCustomerFacing,
                EG_IsExcluded,
                IsEntryPoint,
                IsAzureResource,
                RiskFactor_Probability,
                RawCriticality,
                RiskFactors,
                CVESeverity;

        // Step 1 Find devices/computers with CVEs (vulnerabilities)
        let DevicesWithCVEs =
            ExposureGraphEdges
            | where SourceNodeLabel == "Cve"
            | where EdgeLabel == "affecting"
            | where TargetNodeLabel in ("device", "computer-account", "microsoft.compute/virtualmachines")
            // Join to the CVE node (SourceNodeId) to get CVESeverity from node properties
            | join kind=leftouter (Nodes) on $left.SourceNodeId == $right.AssetNodeId
            | summarize
                CVEs             = make_set(SourceNodeName),
                CVESeverities    = make_set(CVESeverity),
                CVECount         = dcount(SourceNodeId),
                HighSeverityCVEs = countif(
                                       tolower(CVESeverity) has "critical"
                                    or tolower(CVESeverity) has "high"
                                    or tolower(CVESeverity) has "medium"
                                  ),
                FirstCVE         = any(SourceNodeName),
                FirstCVESeverity = any(CVESeverity)
              by DeviceNodeId    = TargetNodeId,
                 DeviceNodeName  = TargetNodeName,
                 DeviceNodeLabel = TargetNodeLabel;

        // Step 2 Find ANY credentials/secrets/identities on those vulnerable devices
        let CredentialsOnVulnerableDevices =
            DevicesWithCVEs
            | join kind=inner (
                ExposureGraphEdges
                | where EdgeLabel in ("contains", "defined in", "runs on", "has credentials of", "frequently logged in by")
                | where TargetNodeLabel in (
                    "user",
                    "serviceprincipal",
                    "managedidentity",
                    "entra-userCookie",
                    "azure-active-directory-app-secret",
                    "user-azure-cli-secret",
                    "azure-storage-shared-access-signature",
                    "azure-storage-connection-string",
                    "azure-database-connection-string",
                    "azure-app-configuration-key",
                    "azure-active-directory-user-credentials",
                    "service-principal-azure-cli-secret"
                )
            ) on $left.DeviceNodeId == $right.SourceNodeId
            | project
                DeviceNodeId, DeviceNodeName, DeviceNodeLabel,
                CVEs, CVESeverities, CVECount, HighSeverityCVEs, FirstCVE, FirstCVESeverity,
                CredentialNodeId    = TargetNodeId,
                CredentialNodeName  = TargetNodeName,
                CredentialNodeLabel = TargetNodeLabel;

        // Step 3 Find what identities these credentials can authenticate as
        let CredentialToIdentity =
            CredentialsOnVulnerableDevices
            | join kind=inner (
                ExposureGraphEdges
                | where EdgeLabel in ("has credentials of", "can authenticate as", "can authenticate to")
            ) on $left.CredentialNodeId == $right.SourceNodeId
            | project
                DeviceNodeId, DeviceNodeName, DeviceNodeLabel,
                CVEs, CVESeverities, CVECount, HighSeverityCVEs, FirstCVE, FirstCVESeverity,
                CredentialNodeId, CredentialNodeName, CredentialNodeLabel,
                IdentityNodeId    = TargetNodeId,
                IdentityNodeName  = TargetNodeName,
                IdentityNodeLabel = TargetNodeLabel;

        // Step 4 Find what Azure resources these identities can access
        CredentialToIdentity
        | join kind=inner (
            ExposureGraphEdges
            | where EdgeLabel in ("can authenticate to", "has permissions to", "has role on")
            | where TargetNodeLabel in (
                "microsoft.keyvault/vaults",
                "microsoft.storage/storageaccounts",
                "microsoft.sql/servers",
                "microsoft.sql/servers/databases",
                "microsoft.compute/virtualmachines",
                "microsoft.compute/virtualmachines/extensions",
                "microsoft.cognitiveservices/accounts",
                "microsoft.cognitiveservices/accounts/deployments",
                "microsoft.cognitiveservices/accounts_openai",
                "microsoft.operationalinsights/workspaces",
                "microsoft.web/sites_webapp",
                "microsoft.web/serverfarms",
                "microsoft.logic/workflows",
                "microsoft.network/virtualnetworks",
                "microsoft.network/virtualnetworks/subnets",
                "microsoft.network/networksecuritygroups",
                "subscriptions",
                "resourcegroups",
                "BlobContainer",
                "device",
                "computer-account"
            )
        ) on $left.IdentityNodeId == $right.SourceNodeId

        | where DeviceNodeId != TargetNodeId

        | summarize
            CVEs                = any(CVEs),
            CVESeverities       = any(CVESeverities),
            CVECount            = any(CVECount),
            HighSeverityCVEs    = any(HighSeverityCVEs),
            FirstCVE            = any(FirstCVE),
            FirstCVESeverity    = any(FirstCVESeverity),
            CredentialNodeName  = any(CredentialNodeName),
            CredentialNodeLabel = any(CredentialNodeLabel),
            IdentityNodeName    = any(IdentityNodeName),
            IdentityNodeLabel   = any(IdentityNodeLabel),
            EdgeLabel           = any(EdgeLabel)
          by DeviceNodeId, DeviceNodeName, DeviceNodeLabel, TargetNodeId, TargetNodeName, TargetNodeLabel

        | join kind=leftouter (Nodes) on $left.DeviceNodeId == $right.AssetNodeId
        | join kind=leftouter (Nodes) on $left.TargetNodeId == $right.AssetNodeId

        | extend
            SourceDeviceCriticality      = CriticalityTier,
            SourceDeviceCriticalityLevel = CriticalityTierLevel,
            TargetCriticality            = CriticalityTier1,
            TargetCriticalityLevel       = CriticalityTierLevel1,
            TargetIsCustomerFacing       = EG_IsCustomerFacing1,
            TargetCriticalityRuleBased   = CriticalityRuleBased1,
            TargetCriticalityRuleNames   = CriticalityRuleNames1,
            TargetRiskProbability        = RiskFactor_Probability1

        | extend TierEscalation =
            case(
                SourceDeviceCriticality > TargetCriticality, SourceDeviceCriticality - TargetCriticality,
                0
            )

        | extend TargetTypeFriendly =
            case(
                TargetNodeLabel == "microsoft.keyvault/vaults", "Key vault",
                TargetNodeLabel == "microsoft.storage/storageaccounts", "Storage account",
                TargetNodeLabel == "microsoft.sql/servers", "SQL server",
                TargetNodeLabel == "microsoft.sql/servers/databases", "SQL database",
                TargetNodeLabel == "microsoft.compute/virtualmachines", "Virtual machine",
                TargetNodeLabel == "microsoft.compute/virtualmachines/extensions", "VM extension",
                TargetNodeLabel == "microsoft.cognitiveservices/accounts", "Azure AI service",
                TargetNodeLabel == "microsoft.cognitiveservices/accounts_openai", "Azure OpenAI",
                TargetNodeLabel == "microsoft.cognitiveservices/accounts/deployments", "Azure AI deployment",
                TargetNodeLabel == "microsoft.operationalinsights/workspaces", "Log Analytics workspace",
                TargetNodeLabel == "microsoft.web/sites_webapp", "Web App",
                TargetNodeLabel == "microsoft.web/serverfarms", "App Service plan",
                TargetNodeLabel == "microsoft.logic/workflows", "Logic App",
                TargetNodeLabel == "microsoft.network/virtualnetworks", "Virtual network",
                TargetNodeLabel == "microsoft.network/networksecuritygroups", "Network Security Group",
                TargetNodeLabel == "subscriptions", "Subscription",
                TargetNodeLabel == "resourcegroups", "Resource group",
                TargetNodeLabel == "BlobContainer", "Blob container",
                TargetNodeLabel == "device", "Device",
                TargetNodeLabel == "computer-account", "Computer account",
                TargetNodeLabel
            )

        | extend EntryPointTypeFriendly =
            case(
                DeviceNodeLabel == "device", "Device",
                DeviceNodeLabel == "computer-account", "Computer account",
                DeviceNodeLabel == "microsoft.compute/virtualmachines", "Virtual machine",
                DeviceNodeLabel
            )

        | extend AttackPathName =
            case(
                HighSeverityCVEs > 0 and TargetCriticalityLevel in ("Critical - tier 0", "High - tier 1") and TargetNodeLabel == "microsoft.keyvault/vaults",
                "Device with high severity vulnerabilities allows lateral movement to Critical Azure Key Vault",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.keyvault/vaults",
                "Device with high severity vulnerabilities allows lateral movement to Azure Key Vault",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.storage/storageaccounts",
                "Device with high severity vulnerabilities allows lateral movement to Azure storage account",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.cognitiveservices/accounts",
                "Device with high severity vulnerabilities allows lateral movement to Azure AI service",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.cognitiveservices/accounts_openai",
                "Device with high severity vulnerabilities allows lateral movement to Azure OpenAI",

                HighSeverityCVEs > 0 and TargetNodeLabel == "subscriptions",
                "Device with high severity vulnerabilities allows lateral movement to Azure subscription",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.sql/servers/databases",
                "Device with high severity vulnerabilities allows lateral movement to Azure SQL database",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.web/sites_webapp",
                "Device with high severity vulnerabilities allows lateral movement to Azure Web App",

                HighSeverityCVEs > 0 and TargetNodeLabel == "microsoft.logic/workflows",
                "Device with high severity vulnerabilities allows lateral movement to Azure Logic App",

                strcat("Device with vulnerabilities allows lateral movement to ", TargetTypeFriendly)
            )

        | extend RiskLevel =
            case(
                TargetCriticalityLevel in ("Critical - tier 0", "High - tier 1") and HighSeverityCVEs >= 3, "High",
                TargetCriticalityLevel in ("Critical - tier 0", "High - tier 1") and HighSeverityCVEs >= 1, "Medium",
                HighSeverityCVEs >= 5, "Medium",
                "Low"
            )

        | extend PathType = "Hybrid"

        | extend SecuritySeverityScore =
            case(
                TierEscalation >= 3 and TargetCriticality == 0, 10,
                TierEscalation >= 2 and TargetCriticality == 0, 9,
                TierEscalation >= 1 and TargetCriticality == 0, 8,
                HighSeverityCVEs >= 5 and TargetCriticality <= 1, 8,
                HighSeverityCVEs >= 3 and TargetCriticality <= 1, 7,
                TargetCriticality == 0, 7,
                TierEscalation >= 2 and TargetCriticality == 1, 7,
                TierEscalation >= 1 and TargetCriticality == 1, 6,
                TargetCriticality == 1, 5,
                HighSeverityCVEs >= 3, 5,
                4
            )
        | extend SecuritySeverityLevel =
            case(
                SecuritySeverityScore >= 9, "Critical",
                SecuritySeverityScore >= 7, "Very High",
                SecuritySeverityScore >= 5, "High",
                SecuritySeverityScore >= 3, "Medium-High",
                "Medium"
            )

        | extend SecurityDomain = "Endpoint"
        | extend Category = "AttackPath_VulnerableDeviceToAzure"
        | extend Subcategory =
            case(
                TierEscalation >= 3, strcat("CVE-Based Escalation: Tier ", SourceDeviceCriticality, " to Tier ", TargetCriticality),
                TierEscalation >= 2, strcat("CVE-Based Escalation: Tier ", SourceDeviceCriticality, " to Tier ", TargetCriticality),
                TierEscalation >= 1, strcat("CVE-Based Movement: Tier ", SourceDeviceCriticality, " to Tier ", TargetCriticality),
                strcat("Vulnerable Device to ", TargetTypeFriendly)
            )

        | extend RiskFactors = "Lateral movement, Vulnerabilities"

        //
        // FIX CriticalityTier + CriticalityTierLevel should be derived from TargetCriticalityLevel (tier 0-3 mapping)
        //
        | extend CriticalityTier =
            case(
                TargetCriticalityLevel == "Critical - tier 0", 0,
                TargetCriticalityLevel == "High - tier 1", 1,
                TargetCriticalityLevel == "Medium - tier 2", 2,
                3
            )
        | extend CriticalityTierLevel =
            case(
                CriticalityTier == 0, "Critical - tier 0",
                CriticalityTier == 1, "High - tier 1",
                CriticalityTier == 2, "Medium - tier 2",
                "Low - tier 3"
            )

        | project
            SecurityDomain,
            Category,
            Subcategory,
            AssetName = DeviceNodeName,
            AssetLabel = EntryPointTypeFriendly,
            ConfigurationName = "CVE",
            ConfigurationId = FirstCVE,
            AttackPathName,
            EntryPoint = DeviceNodeName,
            EntryPointType = EntryPointTypeFriendly,
            Target = TargetNodeName,
            TargetType = TargetTypeFriendly,
            TargetCriticality =
                case(
                TargetCriticality == 0, "Critical",
                TargetCriticality == 1, "High",
                TargetCriticality == 2, "Medium",
                "Low"
            ),
            Type = PathType,
            RiskLevel,
            RiskFactors,
            SourceDeviceCriticality = SourceDeviceCriticalityLevel,
            TargetCriticalityDetailed = TargetCriticalityLevel,
            TierEscalation,
            CVECount,
            HighSeverityCVEs,
            FirstCVE,
            FirstCVESeverity,
            AllCVEs = CVEs,
            CredentialType = CredentialNodeLabel,
            CredentialNode = CredentialNodeName,
            IntermediateIdentity = IdentityNodeName,
            IntermediateIdentityType = IdentityNodeLabel,
            SecuritySeverity = SecuritySeverityLevel,
            SecurityScore = SecuritySeverityScore,
            CriticalityTier,
            CriticalityTierLevel,
            CriticalityRuleBased = TargetCriticalityRuleBased,
            CriticalityRuleNames = TargetCriticalityRuleNames,
            IsCustomerFacing = TargetIsCustomerFacing,
            AttackPathDetailed =
                strcat(
                    "ENTRY: ", EntryPointTypeFriendly, " [", DeviceNodeName, "] with ", HighSeverityCVEs, " high-severity CVE(s) -> ",
                    "CREDENTIAL: ", CredentialNodeLabel, " [", CredentialNodeName, "] -> ",
                    "IDENTITY: ", IdentityNodeLabel, " [", IdentityNodeName, "] -> ",
                    "TARGET: ", TargetTypeFriendly, " [", TargetNodeName, "] (", TargetCriticalityLevel, ")"
                )
        | order by SecurityScore desc, TierEscalation desc, CVECount desc, HighSeverityCVEs desc


ReportTemplates:
  - ReportName: RiskAnalysis_Detailed_v2_Bucket_8
    ReportPurpose: Overview
    ReportsIncluded:
      - Name: Device_Recommendations_Detailed_BucketFilter_v2
        UseQueryBucketing: true
        DefaultBucketCount: 8
        BucketPlaceholderToken: "__BUCKET_FILTER__"
      - Name: Device_Missing_CVEs_Detailed_BucketFilter_v2
        UseQueryBucketing: true
        DefaultBucketCount: 8
        BucketPlaceholderToken: "__BUCKET_FILTER__"
      - Name: Azure_Recommendations_Detailed_v2
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"

  - ReportName: RiskAnalysis_Detailed_v2_Bucket_2
    ReportPurpose: Overview
    ReportsIncluded:
      - Name: Device_Recommendations_Detailed_BucketFilter_v2
        UseQueryBucketing: true
        DefaultBucketCount: 2
        BucketPlaceholderToken: "__BUCKET_FILTER__"
      - Name: Device_Missing_CVEs_Detailed_BucketFilter_v2
        UseQueryBucketing: true
        DefaultBucketCount: 2
        BucketPlaceholderToken: "__BUCKET_FILTER__"
      - Name: Azure_Recommendations_Detailed_v2
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
  
  - ReportName: RiskAnalysis_Summary_v2
    ReportPurpose: Overview
    ReportsIncluded:
      - Name: Device_Recommendations_Summary_v2
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Device_Missing_CVEs_Summary_v2
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Azure_Recommendations_Summary_v2
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"

  - ReportName: AttackPaths_Detailed_v2
    ReportPurpose: Attack Paths
    ReportsIncluded:
      - Name: Attack_Paths_Detailed_v2_Credential_Based_Lateral_Movement
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Attack_Paths_Detailed_v2_Github_to_Azure_Resources
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Attack_Paths_Detailed_v2_Public_IP_to_VM_with_CVE_Exploitation
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Attack_Paths_Detailed_v2_Identity_Group_Membership_to_Privileged_Resources
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Attack_Paths_Detailed_v2_Data_Sensitivity_to_Exposed_Credentials
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"
      - Name: Attack_Paths_Detailed_v2_Device_with_high_severity_vulnerabilities_allows_lateral_movement_Azure
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"

  - ReportName: AttackPaths_Detailed_v2_Test
    ReportPurpose: Attack Paths
    ReportsIncluded:
      - Name: Attack_Paths_Detailed_v2_Device_with_high_severity_vulnerabilities_allows_lateral_movement_Azure
        UseQueryBucketing: false
        DefaultBucketCount: 0
        BucketPlaceholderToken: "N/A"

